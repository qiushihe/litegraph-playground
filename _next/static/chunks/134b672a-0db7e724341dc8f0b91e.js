(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[288],{8691:function(t,e,i){var n=i(34155);!function(t){var e=t.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,registerNodeType:function(t,i){if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,e.debug&&console.log("Node registered: "+t);t.split("/");var n=i.name,s=t.lastIndexOf("/");if(i.category=t.substr(0,s),i.title||(i.title=n),i.prototype)for(var r in o.prototype)i.prototype[r]||(i.prototype[r]=o.prototype[r]);var a=this.registered_node_types[t];if(a)console.log("replacing node type: "+t);else if(Object.hasOwnProperty(i.prototype,"shape")||Object.defineProperty(i.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=e.BOX_SHAPE;break;case"round":this._shape=e.ROUND_SHAPE;break;case"circle":this._shape=e.CIRCLE_SHAPE;break;case"card":this._shape=e.CARD_SHAPE;break;default:this._shape=t}},get:function(t){return this._shape},enumerable:!0,configurable:!0}),i.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),i.supported_extensions)for(var r in i.supported_extensions){(l=i.supported_extensions[r])&&l.constructor===String&&(this.node_types_by_file_extension[l.toLowerCase()]=i)}if(this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[n]=i),e.onNodeTypeRegistered&&e.onNodeTypeRegistered(t,i),a&&e.onNodeTypeReplaced&&e.onNodeTypeReplaced(t,i,a),i.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),i.supported_extensions)for(r=0;r<i.supported_extensions.length;r++){var l;(l=i.supported_extensions[r])&&l.constructor===String&&(this.node_types_by_file_extension[l.toLowerCase()]=i)}},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},wrapFunctionAsNode:function(t,i,n,s,o){for(var r=Array(i.length),a="",l=e.getParameterNames(i),h=0;h<l.length;++h)a+="this.addInput('"+l[h]+"',"+(n&&n[h]?"'"+n[h]+"'":"0")+");\n";a+="this.addOutput('out',"+(s?"'"+s+"'":0)+");\n",o&&(a+="this.properties = "+JSON.stringify(o)+";\n");var u=Function(a);u.title=t.split("/").pop(),u.desc="Generated from "+i.name,u.prototype.onExecute=function(){for(var t=0;t<r.length;++t)r[t]=this.getInputData(t);var e=i.apply(this,r);this.setOutputData(0,e)},this.registerNodeType(t,u)},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var i in o.prototype[t]=e,this.registered_node_types){var n=this.registered_node_types[i];n.prototype[t]&&(n.prototype["_"+t]=n.prototype[t]),n.prototype[t]=e}},createNode:function(t,i,n){var s=this.registered_node_types[t];if(!s)return e.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;s.prototype;i=i||s.title||t;var o=null;if(e.catch_exceptions)try{o=new s(i)}catch(a){return console.error(a),null}else o=new s(i);if(o.type=t,!o.title&&i&&(o.title=i),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=e.DEFAULT_POSITION.concat()),o.mode||(o.mode=e.ALWAYS),n)for(var r in n)o[r]=n[r];return o},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var i=[];for(var n in this.registered_node_types){var s=this.registered_node_types[n];s.filter==e&&(""==t?null==s.category&&i.push(s):s.category==t&&i.push(s))}return this.auto_sort_node_types&&i.sort((function(t,e){return t.title.localeCompare(e.title)})),i},getNodeTypesCategories:function(t){var e={"":1};for(var i in this.registered_node_types){var n=this.registered_node_types[i];if(n.category&&!n.skip_list){if(n.filter!=t)continue;e[n.category]=1}}var s=[];for(var i in e)s.push(i);return this.auto_sort_node_types?s.sort():s},reloadNodes:function(t){for(var i=document.getElementsByTagName("script"),n=[],s=0;s<i.length;s++)n.push(i[s]);var o=document.getElementsByTagName("head")[0];t=document.location.href+t;for(s=0;s<n.length;s++){var r=n[s].src;if(r&&r.substr(0,t.length)==t)try{e.debug&&console.log("Reloading: "+r);var a=document.createElement("script");a.type="text/javascript",a.src=r,o.appendChild(a),o.removeChild(n[s])}catch(l){if(e.throw_errors)throw l;e.debug&&console.log("Error while reloading "+r)}}e.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var i=JSON.parse(JSON.stringify(t));if(!e)return i;for(var n in i)e[n]=i[n];return e},isValidConnection:function(t,i){if(!t||!i||t==i||t==e.EVENT&&i==e.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),-1==t.indexOf(",")&&-1==i.indexOf(","))return t==i;for(var n=t.split(","),s=i.split(","),o=0;o<n.length;++o)for(var r=0;r<s.length;++r)if(n[o]==s[r])return!0;return!1},registerSearchboxExtra:function(t,e,i){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:i}},fetchFile:function(t,i,n,s){if(!t)return null;if(i=i||"text",t.constructor===String)return"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then((function(t){if(!t.ok)throw new Error("File not found");return"arraybuffer"==i?t.arrayBuffer():"text"==i||"string"==i?t.text():"json"==i?t.json():"blob"==i?t.blob():void 0})).then((function(t){n&&n(t)})).catch((function(e){console.error("error fetching file:",t),s&&s(e)}));if(t.constructor===File||t.constructor===Blob){var o=new FileReader;if(o.onload=function(t){var e=t.target.result;"json"==i&&(e=JSON.parse(e)),n&&n(e)},"arraybuffer"==i)return o.readAsArrayBuffer(t);if("text"==i||"json"==i)return o.readAsText(t);if("blob"==i)return o.readAsBinaryString(t)}return null}};function i(t){e.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function s(t,e,i,n,s,o){this.id=t,this.type=e,this.origin_id=i,this.origin_slot=n,this.target_id=s,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}function o(t){this._ctor(t)}function r(t){this._ctor(t)}function a(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function l(t,i,n){this.options=n=n||{},this.background_image=l.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new a,this.zoom_modify_alpha=!0,this.title_text_font=e.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+e.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=e.NODE_TITLE_COLOR,this.default_link_color=e.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=e.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=n.viewport||null,i&&i.attachCanvas(this),this.setCanvas(t,n.skip_events),this.clear(),n.skip_render||this.startRendering(),this.autoresize=n.autoresize}"undefined"!=typeof performance?e.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?e.getTime=Date.now.bind(Date):e.getTime="undefined"!=typeof n?function(){var t=n.hrtime();return.001*t[0]+1e-6*t[1]}:function(){return(new Date).getTime()},t.LGraph=e.LGraph=i,i.supported_types=["number","string","boolean"],i.prototype.getSupportedTypes=function(){return this.supported_types||i.supported_types},i.STATUS_STOPPED=1,i.STATUS_RUNNING=2,i.prototype.clear=function(){if(this.stop(),this.status=i.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},i.prototype.attachCanvas=function(t){if(t.constructor!=l)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},i.prototype.detachCanvas=function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!=e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}},i.prototype.start=function(t){if(this.status!=i.STATUS_RUNNING){this.status=i.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=e.getTime(),this.last_update_time=this.starttime;var n=this;if(0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function t(){-1==n.execution_timer_id&&(window.requestAnimationFrame(t),n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep())}()}else this.execution_timer_id=setInterval((function(){n.onBeforeStep&&n.onBeforeStep(),n.runStep(1,!n.catch_errors),n.onAfterStep&&n.onAfterStep()}),t)}},i.prototype.stop=function(){this.status!=i.STATUS_STOPPED&&(this.status=i.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},i.prototype.runStep=function(t,i,n){t=t||1;var s=e.getTime();this.globaltime=.001*(s-this.starttime);var o=this._nodes_executable?this._nodes_executable:this._nodes;if(o){if(n=n||o.length,i){for(var r=0;r<t;r++){for(var a=0;a<n;++a){(l=o[a]).mode==e.ALWAYS&&l.onExecute&&l.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(r=0;r<t;r++){for(a=0;a<n;++a){var l;(l=o[a]).mode==e.ALWAYS&&l.onExecute&&l.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(p){if(this.errors_in_execution=!0,e.throw_errors)throw p;e.debug&&console.log("Error during execution: "+p),this.stop()}var h=e.getTime(),u=h-s;0==u&&(u=1),this.execution_time=.001*u,this.globaltime+=.001*u,this.iteration+=1,this.elapsed_time=.001*(h-this.last_update_time),this.last_update_time=h}},i.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},i.prototype.computeExecutionOrder=function(t,i){for(var n=[],s=[],o={},r={},a={},l=0,h=this._nodes.length;l<h;++l){var u=this._nodes[l];if(!t||u.onExecute){o[u.id]=u;var p=0;if(u.inputs)for(var c=0,d=u.inputs.length;c<d;c++)u.inputs[c]&&null!=u.inputs[c].link&&(p+=1);0==p?(s.push(u),i&&(u._level=1)):(i&&(u._level=0),a[u.id]=p)}}for(;0!=s.length;){u=s.shift();if(n.push(u),delete o[u.id],u.outputs)for(l=0;l<u.outputs.length;l++){var g=u.outputs[l];if(null!=g&&null!=g.links&&0!=g.links.length)for(c=0;c<g.links.length;c++){var _=g.links[c],f=this.links[_];if(f&&!r[f.id]){var v=this.getNodeById(f.target_id);null!=v?(i&&(!v._level||v._level<=u._level)&&(v._level=u._level+1),r[f.id]=!0,a[v.id]-=1,0==a[v.id]&&s.push(v)):r[f.id]=!0}}}}for(var l in o)n.push(o[l]);n.length!=this._nodes.length&&e.debug&&console.warn("something went wrong, nodes missing");for(h=n.length,l=0;l<h;++l)n[l].order=l;n=n.sort((function(t,e){var i=t.constructor.priority||t.priority||0,n=e.constructor.priority||e.priority||0;return i==n?t.order-e.order:i-n}));for(l=0;l<h;++l)n[l].order=l;return n},i.prototype.getAncestors=function(t){for(var e=[],i=[t],n={};i.length;){var s=i.shift();if(s.inputs){n[s.id]||s==t||(n[s.id]=!0,e.push(s));for(var o=0;o<s.inputs.length;++o){var r=s.getInputNode(o);r&&-1==e.indexOf(r)&&i.push(r)}}}return e.sort((function(t,e){return t.order-e.order})),e},i.prototype.arrange=function(t){t=t||100;for(var i=this.computeExecutionOrder(!1,!0),n=[],s=0;s<i.length;++s){var o=(p=i[s])._level||1;n[o]||(n[o]=[]),n[o].push(p)}var r=t;for(s=0;s<n.length;++s){var a=n[s];if(a){for(var l=100,h=t+e.NODE_TITLE_HEIGHT,u=0;u<a.length;++u){var p;(p=a[u]).pos[0]=r,p.pos[1]=h,p.size[0]>l&&(l=p.size[0]),h+=p.size[1]+t+e.NODE_TITLE_HEIGHT}r+=l+t}}this.setDirtyCanvas(!0,!0)},i.prototype.getTime=function(){return this.globaltime},i.prototype.getFixedTime=function(){return this.fixedtime},i.prototype.getElapsedTime=function(){return this.elapsed_time},i.prototype.sendEventToAllNodes=function(t,i,n){n=n||e.ALWAYS;var s=this._nodes_in_order?this._nodes_in_order:this._nodes;if(s)for(var o=0,r=s.length;o<r;++o){var a=s[o];a.constructor!==e.Subgraph||"onExecute"==t?a[t]&&a.mode==n&&(void 0===i?a[t]():i&&i.constructor===Array?a[t].apply(a,i):a[t](i)):a.mode==n&&a.sendEventToAllNodes(t,i,n)}},i.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var n=this.list_of_graphcanvas[i];n[t]&&n[t].apply(n,e)}},i.prototype.add=function(t,i){if(t){if(t.constructor===r)return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,void this._version++;if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=e.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}},i.prototype.remove=function(t){if(t.constructor===e.LGraphGroup){var i=this._groups.indexOf(t);return-1!=i&&this._groups.splice(i,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var n=0;n<t.inputs.length;n++){null!=(s=t.inputs[n]).link&&t.disconnectInput(n)}if(t.outputs)for(n=0;n<t.outputs.length;n++){var s;null!=(s=t.outputs[n]).links&&s.links.length&&t.disconnectOutput(n)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(n=0;n<this.list_of_graphcanvas.length;++n){var o=this.list_of_graphcanvas[n];o.selected_nodes[t.id]&&delete o.selected_nodes[t.id],o.node_dragged==t&&(o.node_dragged=null)}var r=this._nodes.indexOf(t);-1!=r&&this._nodes.splice(r,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},i.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},i.prototype.findNodesByClass=function(t,e){(e=e||[]).length=0;for(var i=0,n=this._nodes.length;i<n;++i)this._nodes[i].constructor===t&&e.push(this._nodes[i]);return e},i.prototype.findNodesByType=function(t,e){t=t.toLowerCase();(e=e||[]).length=0;for(var i=0,n=this._nodes.length;i<n;++i)this._nodes[i].type.toLowerCase()==t&&e.push(this._nodes[i]);return e},i.prototype.findNodeByTitle=function(t){for(var e=0,i=this._nodes.length;e<i;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},i.prototype.findNodesByTitle=function(t){for(var e=[],i=0,n=this._nodes.length;i<n;++i)this._nodes[i].title==t&&e.push(this._nodes[i]);return e},i.prototype.getNodeOnPos=function(t,e,i,n){for(var s=(i=i||this._nodes).length-1;s>=0;s--){var o=i[s];if(o.isPointInside(t,e,n))return o}return null},i.prototype.getGroupOnPos=function(t,e){for(var i=this._groups.length-1;i>=0;i--){var n=this._groups[i];if(n.isPointInside(t,e,2,!0))return n}return null},i.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var i=this._nodes[t],n=e.registered_node_types[i.type];if(i.constructor!=n){console.log("node being replaced by newer version: "+i.type);var s=e.createNode(i.type);!0,this._nodes[t]=s,s.configure(i.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,i.inputs&&(s.inputs=i.inputs.concat()),i.outputs&&(s.outputs=i.outputs.concat())}}this.updateExecutionOrder()},i.prototype.onAction=function(t,i){this._input_nodes=this.findNodesByClass(e.GraphInput,this._input_nodes);for(var n=0;n<this._input_nodes.length;++n){var s=this._input_nodes[n];if(s.properties.name==t){s.onAction(t,i);break}}},i.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},i.prototype.addInput=function(t,e,i){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:i},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},i.prototype.setInputData=function(t,e){var i=this.inputs[t];i&&(i.value=e)},i.prototype.getInputData=function(t){var e=this.inputs[t];return e?e.value:null},i.prototype.renameInput=function(t,e){if(e!=t){if(!this.inputs[t])return!1;if(this.inputs[e])return console.error("there is already one input with that name"),!1;this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},i.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},i.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.addOutput=function(t,e,i){this.outputs[t]={name:t,type:e,value:i},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},i.prototype.setOutputData=function(t,e){var i=this.outputs[t];i&&(i.value=e)},i.prototype.getOutputData=function(t){var e=this.outputs[t];return e?e.value:null},i.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},i.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},i.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.triggerInput=function(t,e){for(var i=this.findNodesByTitle(t),n=0;n<i.length;++n)i[n].onTrigger(e)},i.prototype.setCallback=function(t,e){for(var i=this.findNodesByTitle(t),n=0;n<i.length;++n)i[n].setTrigger(e)},i.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},i.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},i.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},i.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){if(this.list_of_graphcanvas[t].live_mode)return!0}return!1},i.prototype.clearTriggeredSlots=function(){for(var t in this.links){var e=this.links[t];e&&(e._last_time&&(e._last_time=0))}},i.prototype.change=function(){e.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},i.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},i.prototype.removeLink=function(t){var e=this.links[t];if(e){var i=this.getNodeById(e.target_id);i&&i.disconnectInput(e.target_slot)}},i.prototype.serialize=function(){for(var t=[],i=0,n=this._nodes.length;i<n;++i)t.push(this._nodes[i].serialize());var o=[];for(var i in this.links){var r=this.links[i];if(!r.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var a=new s;for(var l in r)a[l]=r[l];this.links[i]=a,r=a}o.push(r.serialize())}var h=[];for(i=0;i<this._groups.length;++i)h.push(this._groups[i].serialize());var u={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:o,groups:h,config:this.config,extra:this.extra,version:e.VERSION};return this.onSerialize&&this.onSerialize(u),u},i.prototype.configure=function(t,i){if(t){i||this.clear();var n=t.nodes;if(t.links&&t.links.constructor===Array){for(var r=[],a=0;a<t.links.length;++a){var l=t.links[a];if(l){var h=new s;h.configure(l),r[h.id]=h}else console.warn("serialized graph link data contains errors, skipping.")}t.links=r}for(var a in t)"nodes"!=a&&"groups"!=a&&(this[a]=t[a]);var u=!1;if(this._nodes=[],n){a=0;for(var p=n.length;a<p;++a){var c=n[a];(d=e.createNode(c.type,c.title))||(e.debug&&console.log("Node not found or has errors: "+c.type),(d=new o).last_serialization=c,d.has_errors=!0,u=!0),d.id=c.id,this.add(d,!0)}for(a=0,p=n.length;a<p;++a){var d;c=n[a];(d=this.getNodeById(c.id))&&d.configure(c)}}if(this._groups.length=0,t.groups)for(a=0;a<t.groups.length;++a){var g=new e.LGraphGroup;g.configure(t.groups[a]),this.add(g)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),u}},i.prototype.load=function(t,e){var i=this;if(t.constructor===File||t.constructor===Blob){var n=new FileReader;return n.addEventListener("load",(function(t){var n=JSON.parse(t.target.result);i.configure(n),e&&e()})),void n.readAsText(t)}var s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.onload=function(t){if(200===s.status){var n=JSON.parse(s.response);i.configure(n),e&&e()}else console.error("Error loading graph:",s.status,s.response)},s.onerror=function(t){console.error("Error loading graph:",t)}},i.prototype.onNodeTrace=function(t,e,i){},s.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},s.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},e.LLink=s,t.LGraphNode=e.LGraphNode=o,o.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[e.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},o.prototype.configure=function(t){for(var i in this.graph&&this.graph._version++,t)if("properties"!=i)null!=t[i]&&("object"==typeof t[i]?this[i]&&this[i].configure?this[i].configure(t[i]):this[i]=e.cloneObject(t[i],this[i]):this[i]=t[i]);else for(var n in t.properties)this.properties[n]=t.properties[n],this.onPropertyChanged&&this.onPropertyChanged(n,t.properties[n]);if(t.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],r=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange(e.INPUT,s,!0,r,o)}if(this.outputs)for(s=0;s<this.outputs.length;++s){var a=this.outputs[s];if(a.links)for(i=0;i<a.links.length;++i){r=this.graph?this.graph.links[a.links[i]]:null;this.onConnectionsChange(e.OUTPUT,s,!0,r,a)}}}if(this.widgets){for(s=0;s<this.widgets.length;++s){var l=this.widgets[s];l&&(l.options&&l.options.property&&this.properties[l.options.property]&&(l.value=JSON.parse(JSON.stringify(this.properties[l.options.property]))))}if(t.widgets_values)for(s=0;s<t.widgets_values.length;++s)this.widgets[s]&&(this.widgets[s].value=t.widgets_values[s])}this.onConfigure&&this.onConfigure(t)},o.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:e.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===o&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var i=0;i<this.outputs.length;i++)delete this.outputs[i]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=e.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(i=0;i<this.widgets.length;++i)this.widgets[i]?t.widgets_values[i]=this.widgets[i].value:t.widgets_values[i]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},o.prototype.clone=function(){var t=e.createNode(this.type);if(!t)return null;var i=e.cloneObject(this.serialize());if(i.inputs)for(var n=0;n<i.inputs.length;++n)i.inputs[n].link=null;if(i.outputs)for(n=0;n<i.outputs.length;++n)i.outputs[n].links&&(i.outputs[n].links.length=0);return delete i.id,t.configure(i),t},o.prototype.toString=function(){return JSON.stringify(this.serialize())},o.prototype.getTitle=function(){return this.title||this.constructor.title},o.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var i=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,i)&&(this.properties[t]=i),this.widgets)for(var n=0;n<this.widgets.length;++n){var s=this.widgets[n];if(s&&s.options.property==t){s.value=e;break}}}},o.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i._data=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n],o=this.graph.links[s];o&&(o.data=e)}}},o.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.type=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n];this.graph.links[s].type=e}}},o.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)){var i=this.inputs[t].link,n=this.graph.links[i];if(!n)return null;if(!e)return n.data;var s=this.graph.getNodeById(n.origin_id);return s?(s.updateOutputData?s.updateOutputData(n.origin_slot):s.onExecute&&s.onExecute(),n.data):n.data}},o.prototype.getInputDataType=function(t){if(!this.inputs)return null;if(t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,i=this.graph.links[e];if(!i)return null;var n=this.graph.getNodeById(i.origin_id);if(!n)return i.type;var s=n.outputs[i.origin_slot];return s?s.type:null},o.prototype.getInputDataByName=function(t,e){var i=this.findInputSlot(t);return-1==i?null:this.getInputData(i,e)},o.prototype.isInputConnected=function(t){return!!this.inputs&&(t<this.inputs.length&&null!=this.inputs[t].link)},o.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},o.prototype.getInputLink=function(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null},o.prototype.getInputNode=function(t){if(!this.inputs)return null;if(t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var i=this.graph.links[e.link];return i?this.graph.getNodeById(i.origin_id):null},o.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,i=this.inputs.length;e<i;++e){var n=this.inputs[e];if(t==n.name&&null!=n.link){var s=this.graph.links[n.link];if(s)return s.data}}return this.properties[t]},o.prototype.getOutputData=function(t){return this.outputs?t>=this.outputs.length?null:this.outputs[t]._data:null},o.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},o.prototype.isOutputConnected=function(t){return!!this.outputs&&(t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length)},o.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},o.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var i=[],n=0;n<e.links.length;n++){var s=e.links[n],o=this.graph.links[s];if(o){var r=this.graph.getNodeById(o.target_id);r&&i.push(r)}}return i},o.prototype.trigger=function(t,i){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=e.getTime());for(var n=0;n<this.outputs.length;++n){var s=this.outputs[n];!s||s.type!==e.EVENT||t&&s.name!=t||this.triggerSlot(n,i)}}},o.prototype.triggerSlot=function(t,i,n){if(this.outputs){var s=this.outputs[t];if(s){var o=s.links;if(o&&o.length){this.graph&&(this.graph._last_trigger_time=e.getTime());for(var r=0;r<o.length;++r){var a=o[r];if(null==n||n==a){var l=this.graph.links[o[r]];if(l){l._last_time=e.getTime();var h=this.graph.getNodeById(l.target_id);if(h){var u=h.inputs[l.target_slot];h.mode===e.ON_TRIGGER?h.onExecute&&h.onExecute(i):h.onAction&&h.onAction(u.name,i)}}}}}}}},o.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){var i=this.outputs[t];if(i){var n=i.links;if(n&&n.length)for(var s=0;s<n.length;++s){var o=n[s];if(null==e||e==o){var r=this.graph.links[n[s]];r&&(r._last_time=0)}}}}},o.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},o.prototype.addProperty=function(t,e,i,n){var s={name:t,type:i,default_value:e};if(n)for(var o in n)s[o]=n[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s},o.prototype.addOutput=function(t,e,i){var n={name:t,type:e,links:null};if(i)for(var s in i)n[s]=i[s];return this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),n},o.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],n={name:i[0],type:i[1],link:null};if(t[2])for(var s in i[2])n[s]=i[2][s];this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},o.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var i=this.outputs[e].links,n=0;n<i.length;++n){var s=this.graph.links[i[n]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},o.prototype.addInput=function(t,e,i){var n={name:t,type:e=e||0,link:null};if(i)for(var s in i)n[s]=i[s];return this.inputs||(this.inputs=[]),this.inputs.push(n),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(n),this.setDirtyCanvas(!0,!0),n},o.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],n={name:i[0],type:i[1],link:null};if(t[2])for(var s in i[2])n[s]=i[2][s];this.inputs||(this.inputs=[]),this.inputs.push(n),this.onInputAdded&&this.onInputAdded(n)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},o.prototype.removeInput=function(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),i=t;i<this.inputs.length;++i)if(this.inputs[i]){var n=this.graph.links[this.inputs[i].link];n&&(n.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)},o.prototype.addConnection=function(t,e,i,n){var s={name:t,type:e,pos:i,direction:n,links:null};return this.connections.push(s),s},o.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var i=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=t||new Float32Array([0,0]);i=Math.max(i,1);var s=s=e.NODE_TEXT_SIZE,o=g(this.title),r=0,a=0;if(this.inputs)for(var l=0,h=this.inputs.length;l<h;++l){var u=this.inputs[l];r<(p=g(u.label||u.name||""))&&(r=p)}if(this.outputs)for(l=0,h=this.outputs.length;l<h;++l){var p,c=this.outputs[l];a<(p=g(c.label||c.name||""))&&(a=p)}n[0]=Math.max(r+a+10,o),n[0]=Math.max(n[0],e.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*e.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+i*e.NODE_SLOT_HEIGHT;var d=0;if(this.widgets&&this.widgets.length){for(l=0,h=this.widgets.length;l<h;++l)this.widgets[l].computeSize?d+=this.widgets[l].computeSize(n[0])[1]+4:d+=e.NODE_WIDGET_HEIGHT+4;d+=8}function g(t){return t?s*t.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],d):null!=this.widgets_start_y?n[1]=Math.max(n[1],d+this.widgets_start_y):n[1]+=d,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n},o.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},o.prototype.addWidget=function(t,e,i,n,s){this.widgets||(this.widgets=[]),!s&&n&&n.constructor===Object&&(s=n,n=null),s&&s.constructor===String&&(s={property:s}),n&&n.constructor===String&&(s||(s={}),s.property=n,n=null),n&&n.constructor!==Function&&(console.warn("addWidget: callback must be a function"),n=null);var o={type:t.toLowerCase(),name:e,value:i,callback:n,options:s||{}};if(void 0!==o.options.y&&(o.y=o.options.y),n||o.options.callback||o.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o},o.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},o.prototype.getBounding=function(t){return(t=t||new Float32Array(4))[0]=this.pos[0]-4,t[1]=this.pos[1]-e.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.flags.collapsed?e.NODE_TITLE_HEIGHT:this.size[1]+e.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t},o.prototype.isPointInside=function(t,i,n,s){n=n||0;var o=this.graph&&this.graph.isLive()?0:e.NODE_TITLE_HEIGHT;if(s&&(o=0),this.flags&&this.flags.collapsed){if(v(t,i,this.pos[0]-n,this.pos[1]-e.NODE_TITLE_HEIGHT-n,(this._collapsed_width||e.NODE_COLLAPSED_WIDTH)+2*n,e.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<t&&this.pos[0]+this.size[0]+4+n>t&&this.pos[1]-o-n<i&&this.pos[1]+this.size[1]+n>i)return!0;return!1},o.prototype.getSlotInPosition=function(t,e){var i=new Float32Array(2);if(this.inputs)for(var n=0,s=this.inputs.length;n<s;++n){var o=this.inputs[n];if(this.getConnectionPos(!0,n,i),v(t,e,i[0]-10,i[1]-5,20,10))return{input:o,slot:n,link_pos:i}}if(this.outputs)for(n=0,s=this.outputs.length;n<s;++n){var r=this.outputs[n];if(this.getConnectionPos(!1,n,i),v(t,e,i[0]-10,i[1]-5,20,10))return{output:r,slot:n,link_pos:i}}return null},o.prototype.findInputSlot=function(t){if(!this.inputs)return-1;for(var e=0,i=this.inputs.length;e<i;++e)if(t==this.inputs[e].name)return e;return-1},o.prototype.findOutputSlot=function(t){if(!this.outputs)return-1;for(var e=0,i=this.outputs.length;e<i;++e)if(t==this.outputs[e].name)return e;return-1},o.prototype.connect=function(t,i,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&i.constructor===Number&&(i=this.graph.getNodeById(i)),!i)throw"target node is null";if(i==this)return null;if(n.constructor===String){if(-1==(n=i.findInputSlot(n)))return e.debug&&console.log("Connect: Error, no slot of name "+n),null}else{if(n===e.EVENT)return null;if(!i.inputs||n>=i.inputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),null}var o=!1;null!=i.inputs[n].link&&(this.graph.beforeChange(),i.disconnectInput(n),o=!0);var r=this.outputs[t];if(i.onConnectInput&&!1===i.onConnectInput(n,r.type,r,this,t))return null;var a=i.inputs[n],l=null;return e.isValidConnection(r.type,a.type)?(o||this.graph.beforeChange(),l=new s(++this.graph.last_link_id,a.type,this.id,t,i.id,n),this.graph.links[l.id]=l,null==r.links&&(r.links=[]),r.links.push(l.id),i.inputs[n].link=l.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!0,l,r),i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,n,!0,l,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.INPUT,i,n,this,t),this.graph.onNodeConnectionChange(e.OUTPUT,this,t,i,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,l),l):(this.setDirtyCanvas(!1,!0),o&&this.graph.connectionChange(this,l),null)},o.prototype.disconnectOutput=function(t,i){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[t];if(!n||!n.links||0==n.links.length)return!1;if(i){if(i.constructor===Number&&(i=this.graph.getNodeById(i)),!i)throw"Target Node not found";for(var s=0,o=n.links.length;s<o;s++){var r=n.links[s];if((a=this.graph.links[r]).target_id==i.id){n.links.splice(s,1),(l=i.inputs[a.target_slot]).link=null,delete this.graph.links[r],this.graph&&this.graph._version++,i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,a.target_slot,!1,a,l),this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot));break}}}else{for(s=0,o=n.links.length;s<o;s++){var a;r=n.links[s];if(a=this.graph.links[r]){i=this.graph.getNodeById(a.target_id);var l=null;this.graph&&this.graph._version++,i&&((l=i.inputs[a.target_slot]).link=null,i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,a.target_slot,!1,a,l),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot)),delete this.graph.links[r],this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},o.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.inputs[t];if(!i)return!1;var n=this.inputs[t].link;if(null!=n){this.inputs[t].link=null;var s=this.graph.links[n];if(s){var o=this.graph.getNodeById(s.origin_id);if(!o)return!1;var r=o.outputs[s.origin_slot];if(!r||!r.links||0==r.links.length)return!1;for(var a=0,l=r.links.length;a<l;a++)if(r.links[a]==n){r.links.splice(a,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(e.INPUT,t,!1,s,i),o.onConnectionsChange&&o.onConnectionsChange(e.OUTPUT,a,!1,s,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,o,a),this.graph.onNodeConnectionChange(e.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},o.prototype.getConnectionPos=function(t,i,n){n=n||new Float32Array(2);var s=0;t&&this.inputs&&(s=this.inputs.length),!t&&this.outputs&&(s=this.outputs.length);var o=.5*e.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var r=this._collapsed_width||e.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*r,n[1]=t?this.pos[1]-e.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=t?this.pos[0]:this.pos[0]+r,n[1]=this.pos[1]-.5*e.NODE_TITLE_HEIGHT),n}return t&&-1==i?(n[0]=this.pos[0]+.5*e.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*e.NODE_TITLE_HEIGHT,n):t&&s>i&&this.inputs[i].pos?(n[0]=this.pos[0]+this.inputs[i].pos[0],n[1]=this.pos[1]+this.inputs[i].pos[1],n):!t&&s>i&&this.outputs[i].pos?(n[0]=this.pos[0]+this.outputs[i].pos[0],n[1]=this.pos[1]+this.outputs[i].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(i+.5)*(this.size[0]/s),n[1]=t?this.pos[1]-e.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=t?this.pos[0]+o:this.pos[0]+this.size[0]+1-o,n[1]=this.pos[1]+(i+.7)*e.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)},o.prototype.alignToGrid=function(){this.pos[0]=e.CANVAS_GRID_SIZE*Math.round(this.pos[0]/e.CANVAS_GRID_SIZE),this.pos[1]=e.CANVAS_GRID_SIZE*Math.round(this.pos[1]/e.CANVAS_GRID_SIZE)},o.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>o.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},o.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},o.prototype.loadImage=function(t){var i=new Image;i.src=e.node_images_path+t,i.ready=!1;var n=this;return i.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},i},o.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,i=0;i<e.length;++i){var n=e[i];(t||n.node_capturing_input==this)&&(n.node_capturing_input=t?this:null)}},o.prototype.collapse=function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},o.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},o.prototype.localToScreen=function(t,e,i){return[(t+this.pos[0])*i.scale+i.offset[0],(e+this.pos[1])*i.scale+i.offset[1]]},t.LGraphGroup=e.LGraphGroup=r,r.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=l.node_colors.pale_blue?l.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},r.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font},r.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}},r.prototype.move=function(t,e,i){if(this._pos[0]+=t,this._pos[1]+=e,!i)for(var n=0;n<this._nodes.length;++n){var s=this._nodes[n];s.pos[0]+=t,s.pos[1]+=e}},r.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),i=0;i<t.length;++i){var n=t[i];n.getBounding(e),y(this._bounding,e)&&this._nodes.push(n)}},r.prototype.isPointInside=o.prototype.isPointInside,r.prototype.setDirtyCanvas=o.prototype.setDirtyCanvas,e.DragAndScale=a,a.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),t.addEventListener("mousedown",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},a.prototype.computeVisibleArea=function(t){if(this.element){var e=this.element.width,i=this.element.height,n=-this.offset[0],s=-this.offset[1];t&&(n+=t[0]/this.scale,s+=t[1]/this.scale,e=t[2],i=t[3]);var o=n+e/this.scale,r=s+i/this.scale;this.visible_area[0]=n,this.visible_area[1]=s,this.visible_area[2]=o-n,this.visible_area[3]=r-s}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},a.prototype.onMouse=function(t){if(this.enabled){var e=this.element,i=e.getBoundingClientRect(),n=t.clientX-i.left,s=t.clientY-i.top;t.canvasx=n,t.canvasy=s,t.dragging=this.dragging;var o=!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3],r=!1;if(this.onmouse&&(r=this.onmouse(t)),"mousedown"==t.type&&o)this.dragging=!0,e.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"==t.type){if(!r){var a=n-this.last_mouse[0],l=s-this.last_mouse[1];this.dragging&&this.mouseDrag(a,l)}}else"mouseup"==t.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback)):!o||"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel","wheel"==t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta));return this.last_mouse[0]=n,this.last_mouse[1]=s,o?(t.preventDefault(),t.stopPropagation(),!1):void 0}},a.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},a.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},a.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},a.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},a.prototype.changeScale=function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var i=this.element.getBoundingClientRect();if(i){e=e||[.5*i.width,.5*i.height];var n=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(e),o=[s[0]-n[0],s[1]-n[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}},a.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},a.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},t.LGraphCanvas=e.LGraphCanvas=l,l.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",l.link_type_colors={"-1":e.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},l.gradients={},l.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},l.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),t||!this.graph?(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},l.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},l.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},l.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1}},l.prototype.getCurrentGraph=function(){return this.graph},l.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e||this.bindEvents()}},l.prototype._doNothing=function(t){return t.preventDefault(),!1},l.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},l.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._touch_callback=this.touchHandler.bind(this),t.addEventListener("mousedown",this._mousedown_callback,!0),t.addEventListener("mousemove",this._mousemove_callback),t.addEventListener("mousewheel",this._mousewheel_callback,!1),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),t.addEventListener("touchstart",this._touch_callback,!0),t.addEventListener("touchmove",this._touch_callback,!0),t.addEventListener("touchend",this._touch_callback,!0),t.addEventListener("touchcancel",this._touch_callback,!0),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},l.prototype.unbindEvents=function(){if(this._events_binded){var t=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this._touch_callback),this.canvas.removeEventListener("touchmove",this._touch_callback),this.canvas.removeEventListener("touchend",this._touch_callback),this.canvas.removeEventListener("touchcancel",this._touch_callback),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")},l.getFileExtension=function(t){var e=t.indexOf("?");-1!=e&&(t=t.substr(0,e));var i=t.lastIndexOf(".");return-1==i?"":t.substr(i+1).toLowerCase()},l.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},l.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},l.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},l.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}.call(this))},l.prototype.stopRendering=function(){this.is_rendering=!1},l.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},l.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var i=this.getCanvasWindow();i.document;l.active_canvas=this;var n=this,s=t.localX,o=t.localY;this.ds.viewport=this.viewport;var r=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&o>=this.viewport[1]&&o<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(this.canvas.removeEventListener("mousemove",this._mousemove_callback),i.document.addEventListener("mousemove",this._mousemove_callback,!0),i.document.addEventListener("mouseup",this._mouseup_callback,!0)),r){var a=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),h=!1,u=e.getTime()-this.last_mouseclick<300;if(this.mouse[0]=t.localX,this.mouse[1]=t.localY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.canvas.focus(),e.closeAllContextMenus(i),!this.onMouse||1!=this.onMouse(t)){if(1==t.which){t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,h=!0);var p=!1;if(a&&this.allow_interaction&&!h&&!this.read_only){if(this.live_mode||a.flags.pinned||this.bringToFront(a),!this.connecting_node&&!a.flags.collapsed&&!this.live_mode)if(!h&&!1!==a.resizable&&v(t.canvasX,t.canvasY,a.pos[0]+a.size[0]-5,a.pos[1]+a.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=a,this.canvas.style.cursor="se-resize",h=!0;else{if(a.outputs)for(var c=0,d=a.outputs.length;c<d;++c){var g=a.outputs[c],_=a.getConnectionPos(!1,c);if(v(t.canvasX,t.canvasY,_[0]-15,_[1]-10,30,20)){this.connecting_node=a,this.connecting_output=g,this.connecting_pos=a.getConnectionPos(!1,c),this.connecting_slot=c,t.shiftKey&&a.disconnectOutput(c),u?a.onOutputDblClick&&a.onOutputDblClick(c,t):a.onOutputClick&&a.onOutputClick(c,t),h=!0;break}}if(a.inputs)for(c=0,d=a.inputs.length;c<d;++c){var y=a.inputs[c];_=a.getConnectionPos(!0,c);if(v(t.canvasX,t.canvasY,_[0]-15,_[1]-10,30,20)&&(u?a.onInputDblClick&&a.onInputDblClick(c,t):a.onInputClick&&a.onInputClick(c,t),null!==y.link)){var m=this.graph.links[y.link];a.disconnectInput(c),(this.allow_reconnect_links||t.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[m.origin_id],this.connecting_slot=m.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,h=!0}}}if(!h){var b=!1,T=[t.canvasX-a.pos[0],t.canvasY-a.pos[1]],E=this.processNodeWidgets(a,this.graph_mouse,t);if(E&&(b=!0,this.node_widget=[a,E]),u&&this.selected_nodes[a.id]&&(a.onDblClick&&a.onDblClick(t,T,this),this.processNodeDblClicked(a),b=!0),a.onMouseDown&&a.onMouseDown(t,T,this))b=!0;else{if(a.subgraph&&!a.skip_subgraph_button&&!a.flags.collapsed&&T[0]>a.size[0]-e.NODE_TITLE_HEIGHT&&T[1]<0){n=this;setTimeout((function(){n.openSubgraph(a.subgraph)}),10)}this.live_mode&&(p=!0,b=!0)}b||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=a),this.selected_nodes[a.id]||this.processNodeSelected(a,t)),this.dirty_canvas=!0}}else{if(!this.read_only)for(c=0;c<this.visible_links.length;++c){var w=this.visible_links[c],C=w._pos;if(!(!C||t.canvasX<C[0]-4||t.canvasX>C[0]+4||t.canvasY<C[1]-4||t.canvasY>C[1]+4)){this.showLinkMenu(w,t),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)t.ctrlKey&&(this.dragging_rectangle=null),f([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();u&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(t),p=!0}!h&&p&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==t.which||3==t.which&&(this.read_only||this.processContextMenu(a,t));return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=e.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!i.document.activeElement||"input"!=i.document.activeElement.nodeName.toLowerCase()&&"textarea"!=i.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},l.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){l.active_canvas=this,this.adjustMouseEvent(t);var i=[t.localX,t.localY];this.mouse[0]=i[0],this.mouse[1]=i[1];var n=[i[0]-this.last_mouse[0],i[1]-this.last_mouse[1]];if(this.last_mouse=i,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.block_click)return t.preventDefault(),!1;if(t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var s=n[0]/this.ds.scale,o=n[1]/this.ds.scale;this.selected_group.move(s,o,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var r=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes),a=0,h=this.graph._nodes.length;a<h;++a)this.graph._nodes[a].mouseOver&&r!=this.graph._nodes[a]&&(this.graph._nodes[a].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(r){if(r.redraw_on_mouse&&(this.dirty_canvas=!0),r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(t)),r.onMouseMove&&r.onMouseMove(t,[t.canvasX-r.pos[0],t.canvasY-r.pos[1]],this),this.connecting_node){var u=this._highlight_input||[0,0];if(this.isOverNodeBox(r,t.canvasX,t.canvasY));else{var p=this.isOverNodeInput(r,t.canvasX,t.canvasY,u);if(-1!=p&&r.inputs[p]){var c=r.inputs[p].type;e.isValidConnection(this.connecting_output.type,c)&&(this._highlight_input=u,this._highlight_input_slot=r.inputs[p])}else this._highlight_input=null,this._highlight_input_slot=null}}this.canvas&&(v(t.canvasX,t.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var d=null;for(a=0;a<this.visible_links.length;++a){var g=this.visible_links[a],_=g._pos;if(!(!_||t.canvasX<_[0]-4||t.canvasX>_[0]+4||t.canvasY<_[1]-4||t.canvasY>_[1]+4)){d=g;break}}d!=this.over_link_center&&(this.over_link_center=d,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var a in this.selected_nodes){var f=this.selected_nodes[a];f.pos[0]+=n[0]/this.ds.scale,f.pos[1]+=n[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var y=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],m=this.resizing_node.computeSize();y[0]=Math.max(m[0],y[0]),y[1]=Math.max(m[1],y[1]),this.resizing_node.setSize(y),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},l.prototype.processMouseUp=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var i=this.getCanvasWindow().document;l.active_canvas=this,this.options.skip_events||(i.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),i.removeEventListener("mouseup",this._mouseup_callback,!0)),this.adjustMouseEvent(t);var n=e.getTime();if(t.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(console.log("foo"),this.block_click=!1),1==t.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group){var s=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(s,o,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var r=this.graph._nodes,a=new Float32Array(4);this.deselectAllNodes();var h=Math.abs(this.dragging_rectangle[2]),u=Math.abs(this.dragging_rectangle[3]),p=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-h:this.dragging_rectangle[0],c=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-u:this.dragging_rectangle[1];this.dragging_rectangle[0]=p,this.dragging_rectangle[1]=c,this.dragging_rectangle[2]=h,this.dragging_rectangle[3]=u;for(var d=[],g=0;g<r.length;++g){(m=r[g]).getBounding(a),y(this.dragging_rectangle,a)&&d.push(m)}d.length&&this.selectNodes(d)}this.dragging_rectangle=null}else if(this.connecting_node){if(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,m=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))if(this.connecting_output.type==e.EVENT&&this.isOverNodeBox(m,t.canvasX,t.canvasY))this.connecting_node.connect(this.connecting_slot,m,e.EVENT);else{var _=this.isOverNodeInput(m,t.canvasX,t.canvasY);if(-1!=_)this.connecting_node.connect(this.connecting_slot,m,_);else{var f=m.getInputInfo(0);this.connecting_output.type==e.EVENT?this.connecting_node.connect(this.connecting_slot,m,e.EVENT):f&&!f.link&&e.isValidConnection(f.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,m,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){(m=this.node_dragged)&&t.click_time<300&&v(t.canvasX,t.canvasY,m.pos[0],m.pos[1]-e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT)&&m.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var m;!(m=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},l.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail;this.adjustMouseEvent(t);var i=t.localX,n=t.localY;if(!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3]){var s=this.ds.scale;return e>0?s*=1.1:e<0&&(s*=1/1.1),this.ds.changeScale(s,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}}},l.prototype.isOverNodeBox=function(t,i,n){var s=e.NODE_TITLE_HEIGHT;return!!v(i,n,t.pos[0]+2,t.pos[1]+2-s,s-4,s-4)},l.prototype.isOverNodeInput=function(t,e,i,n){if(t.inputs)for(var s=0,o=t.inputs.length;s<o;++s){t.inputs[s];var r=t.getConnectionPos(!0,s);if(t.horizontal?v(e,i,r[0]-5,r[1]-10,10,20):v(e,i,r[0]-10,r[1]-5,40,10))return n&&(n[0]=r[0],n[1]=r[1]),s}return-1},l.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(this.dragging_canvas=!0,e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),"KeyC"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),"KeyV"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.pasteFromClipboard(),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},l.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,i=[];for(var n in this.selected_nodes){(s=this.selected_nodes[n])._relative_id=e,i.push(s),e+=1}for(n=0;n<i.length;++n){var s,o=(s=i[n]).clone();if(o){if(t.nodes.push(o.serialize()),s.inputs&&s.inputs.length)for(var r=0;r<s.inputs.length;++r){var a=s.inputs[r];if(a&&null!=a.link){var l=this.graph.links[a.link];if(l){var h=this.graph.getNodeById(l.origin_id);h&&this.selected_nodes[h.id]&&t.links.push([h._relative_id,l.origin_slot,s._relative_id,l.target_slot])}}}}else console.warn("node type not found: "+s.type)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},l.prototype.pasteFromClipboard=function(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var i=JSON.parse(t),n=[],s=0;s<i.nodes.length;++s){var o=i.nodes[s],r=e.createNode(o.type);r&&(r.configure(o),r.pos[0]+=5,r.pos[1]+=5,this.graph.add(r),n.push(r))}for(s=0;s<i.links.length;++s){var a=i.links[s],l=n[a[0]],h=n[a[2]];l&&h?l.connect(a[1],h,a[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(n),this.graph.afterChange()}},l.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=t.localX,i=t.localY;if(!this.viewport||this.viewport&&e>=this.viewport[0]&&e<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3]){var n=[t.canvasX,t.canvasY],s=this.graph?this.graph.getNodeOnPos(n[0],n[1]):null;if(!s){var o=null;return this.onDropItem&&(o=this.onDropItem(event)),void(o||this.checkDropItem(t))}if(s.onDropFile||s.onDropData){var r=t.dataTransfer.files;if(r&&r.length)for(var a=0;a<r.length;a++){var h=t.dataTransfer.files[0],u=h.name;l.getFileExtension(u);if(s.onDropFile&&s.onDropFile(h),s.onDropData){var p=new FileReader;p.onload=function(t){var e=t.target.result;s.onDropData(e,u,h)};var c=h.type.split("/")[0];"text"==c||""==c?p.readAsText(h):"image"==c?p.readAsDataURL(h):p.readAsArrayBuffer(h)}}}return!(!s.onDropItem||!s.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}},l.prototype.checkDropItem=function(t){if(t.dataTransfer.files.length){var i=t.dataTransfer.files[0],n=l.getFileExtension(i.name).toLowerCase(),s=e.node_types_by_file_extension[n];if(s){this.graph.beforeChange();var o=e.createNode(s.type);o.pos=[t.canvasX,t.canvasY],this.graph.add(o),o.onDropFile&&o.onDropFile(i),this.graph.afterChange()}}},l.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},l.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(t)},l.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},l.prototype.selectNodes=function(t,e){e||this.deselectAllNodes(),t=t||this.graph._nodes;for(var i=0;i<t.length;++i){var n=t[i];if(!n.is_selected){if(!n.is_selected&&n.onSelected&&n.onSelected(),n.is_selected=!0,this.selected_nodes[n.id]=n,n.inputs)for(var s=0;s<n.inputs.length;++s)this.highlighted_links[n.inputs[s].link]=!0;if(n.outputs)for(s=0;s<n.outputs.length;++s){var o=n.outputs[s];if(o.links)for(var r=0;r<o.links.length;++r)this.highlighted_links[o.links[r]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},l.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var i=t.outputs[e];if(i.links)for(var n=0;n<i.links.length;++n)delete this.highlighted_links[i.links[n]]}}},l.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,i=t.length;e<i;++e){var n=t[e];n.is_selected&&(n.onDeselected&&n.onDeselected(),n.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(n))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},l.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var i=this.selected_nodes[t];if(!i.block_delete){if(i.inputs&&i.inputs.length&&i.outputs&&i.outputs.length&&e.isValidConnection(i.inputs[0].type,i.outputs[0].type)&&i.inputs[0].link&&i.outputs[0].links&&i.outputs[0].links.length){var n=i.graph.links[i.inputs[0].link],s=i.graph.links[i.outputs[0].links[0]],o=i.getInputNode(0),r=i.getOutputNodes(0)[0];o&&r&&o.connect(n.origin_slot,r,s.target_slot)}this.graph.remove(i),this.onNodeDeselected&&this.onNodeDeselected(i)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},l.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},l.prototype.adjustMouseEvent=function(t){if(this.canvas){var e=this.canvas.getBoundingClientRect();t.localX=t.clientX-e.left,t.localY=t.clientY-e.top}else t.localX=t.clientX,t.localY=t.clientY;t.deltaX=t.localX-this.last_mouse_position[0],t.deltaY=t.localY-this.last_mouse_position[1],this.last_mouse_position[0]=t.localX,this.last_mouse_position[1]=t.localY,t.canvasX=t.localX/this.ds.scale-this.ds.offset[0],t.canvasY=t.localY/this.ds.scale-this.ds.offset[1]},l.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},l.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},l.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},l.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},l.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},l.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var h=new Float32Array(4);l.prototype.computeVisibleNodes=function(t,e){var i=e||[];i.length=0;for(var n=0,s=(t=t||this.graph._nodes).length;n<s;++n){var o=t[n];(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(y(this.visible_area,o.getBounding(h))&&i.push(o))}return i},l.prototype.draw=function(t,i){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var n=e.getTime();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||i||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},l.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var i=this.canvas;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));var n=this.viewport||this.dirty_area;if(n&&(t.save(),t.beginPath(),t.rect(n[0],n[1],n[2],n[3]),t.clip()),this.clear_background&&(n?t.clearRect(n[0],n[1],n[2],n[3]):t.clearRect(0,0,i.width,i.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(i,t),this.show_info&&this.renderInfo(t,n?n[0]:0,n?n[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var s=this.computeVisibleNodes(null,this.visible_nodes),o=0;o<s.length;++o){var r=s[o];t.save(),t.translate(r.pos[0],r.pos[1]),this.drawNode(r,t),1,t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var a=null;switch(this.connecting_output.type){case e.EVENT:a=e.EVENT_LINK_COLOR;break;default:a=e.CONNECTING_LINK_COLOR}if(this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,a,this.connecting_output.dir||(this.connecting_node.horizontal?e.DOWN:e.RIGHT),e.CENTER),t.beginPath(),this.connecting_output.type===e.EVENT||this.connecting_output.shape===e.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):this.connecting_output.shape===e.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input)t.beginPath(),this._highlight_input_slot.shape===e.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),n&&t.restore(),t.finish2D&&t.finish2D()}},l.prototype.drawSubgraphPanel=function(t){var e=this.graph,i=e._subgraph_node;i?(this.drawSubgraphPanelLeft(e,i,t),this.drawSubgraphPanelRight(e,i,t)):console.warn("subgraph without subnode")},l.prototype.drawSubgraphPanelLeft=function(t,i,n){var s=i.inputs?i.inputs.length:0,o=200,r=Math.floor(1.6*e.NODE_SLOT_HEIGHT);if(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(10,10,o,(s+1)*r+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left",n.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var a=50;if(n.font="14px Arial",i.inputs)for(var l=0;l<i.inputs.length;++l){var h=i.inputs[l];if(!h.not_subgraph_input){if(this.drawButton(20,a+2,180,r-2)){var u=i.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=e.createNode(u);p?(t.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",h.name),p.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",u)}n.fillStyle="#9C9",n.beginPath(),n.arc(184,a+.5*r,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(h.name,30,a+.75*r),n.fillStyle="#777",n.fillText(h.type,130,a+.75*r),a+=r}}this.drawButton(20,a+2,180,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(i)}},l.prototype.drawSubgraphPanelRight=function(t,i,n){var s=i.outputs?i.outputs.length:0,o=this.bgcanvas.width,r=200,a=Math.floor(1.6*e.NODE_SLOT_HEIGHT);n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(o-r-10,10,r,(s+1)*a+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left";var l="Graph Outputs",h=n.measureText(l).width;if(n.fillText(l,o-h-20,34),this.drawButton(o-r,20,20,20,"X","#151515"))this.closeSubgraph();else{var u=50;if(n.font="14px Arial",i.outputs)for(var p=0;p<i.outputs.length;++p){var c=i.outputs[p];if(!c.not_subgraph_input){if(this.drawButton(o-r,u+2,180,a-2)){var d=i.constructor.output_node_type||"graph/output";this.graph.beforeChange();var g=e.createNode(d);g?(t.add(g),this.block_click=!1,this.last_click_position=null,this.selectNodes([g]),this.node_dragged=g,this.dragging_canvas=!1,g.setProperty("name",c.name),g.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",d)}n.fillStyle="#9C9",n.beginPath(),n.arc(o-r+16,u+.5*a,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(c.name,o-r+30,u+.75*a),n.fillStyle="#777",n.fillText(c.type,o-r+130,u+.75*a),u+=a}}this.drawButton(o-r,u+2,180,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(i)}},l.prototype.drawButton=function(t,i,n,s,o,r,a,l){var h=this.ctx;r=r||e.NODE_DEFAULT_COLOR,a=a||"#555",l=l||e.NODE_TEXT_COLOR;var u=this.mouse,p=e.isInsideRectangle(u[0],u[1],t,i,n,s),c=(u=this.last_click_position)&&e.isInsideRectangle(u[0],u[1],t,i,n,s);h.fillStyle=p?a:r,c&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(t,i,n,s,[4]),h.fill(),null!=o&&o.constructor==String&&(h.fillStyle=l,h.textAlign="center",h.font=(.65*s|0)+"px Arial",h.fillText(o,t+.5*n,i+.75*s),h.textAlign="left");var d=c&&!this.block_click;return c&&this.blockClick(),d},l.prototype.isAreaClicked=function(t,i,n,s,o){var r=this.mouse,a=(e.isInsideRectangle(r[0],r[1],t,i,n,s),(r=this.last_click_position)&&e.isInsideRectangle(r[0],r[1],t,i,n,s)),l=a&&!this.block_click;return a&&o&&this.blockClick(),l},l.prototype.renderInfo=function(t,e,i){e=e||10,i=i||this.canvas.height-80,t.save(),t.translate(e,i),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},l.prototype.drawBackCanvas=function(){var t=this.bgcanvas;t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;e.start&&e.start();var i=this.viewport||[0,0,e.canvas.width,e.canvas.height];if(this.clear_background&&e.clearRect(i[0],i[1],i[2],i[3]),this._graph_stack&&this._graph_stack.length){e.save();this._graph_stack[this._graph_stack.length-1];var n=this.graph._subgraph_node;e.strokeStyle=n.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=n.bgcolor||"#AAA";for(var s="",o=1;o<this._graph_stack.length;++o)s+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";e.fillText(s+n.getTitle(),.5*t.width,40),e.restore()}var r=!1;if(this.onRenderBackground&&(r=this.onRenderBackground(t,e)),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.background_image&&this.ds.scale>.5&&!r){if(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var a=this;this._bg_img.onload=function(){a.draw(!0,!0)}}var l=null;null==this._pattern&&this._bg_img.width>0?(l=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=l):l=this._pattern,l&&(e.fillStyle=l,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var u=new Float32Array(2);l.prototype.drawNode=function(t,i){this.current_node=t;var n=t.color||t.constructor.color||e.NODE_DEFAULT_COLOR,s=t.bgcolor||t.constructor.bgcolor||e.NODE_DEFAULT_BGCOLOR;t.mouseOver;var o=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(i.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(i,this,this.canvas));else{var r=this.editor_alpha;if(i.globalAlpha=r,this.render_shadows&&!o?(i.shadowColor=e.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(i,this)){var a=t._shape||e.BOX_SHAPE,l=u;u.set(t.size);var h=t.horizontal;if(t.flags.collapsed){i.font=this.inner_text_font;var p=t.getTitle?t.getTitle():t.title;null!=p&&(t._collapsed_width=Math.min(t.size[0],i.measureText(p).width+2*e.NODE_TITLE_HEIGHT),l[0]=t._collapsed_width,l[1]=0)}t.clip_area&&(i.save(),i.beginPath(),a==e.BOX_SHAPE?i.rect(0,0,l[0],l[1]):a==e.ROUND_SHAPE?i.roundRect(0,0,l[0],l[1],[10]):a==e.CIRCLE_SHAPE&&i.arc(.5*l[0],.5*l[1],.5*l[0],0,2*Math.PI),i.clip()),t.has_errors&&(s="red"),this.drawNodeShape(t,i,l,n,s,t.is_selected,t.mouseOver),i.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(i,this,this.canvas),i.textAlign=h?"center":"left",i.font=this.inner_text_font;var c=!o,d=this.connecting_output;i.lineWidth=1;var g=0,_=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var f=null,v=null;if(t.inputs)for(b=0;b<t.inputs.length;b++){if(null!=(T=t.inputs[b]).link){f=T;break}}if(t.outputs)for(b=0;b<t.outputs.length;b++){(T=t.outputs[b]).links&&T.links.length&&(v=T)}if(f){var y=0,m=-.5*e.NODE_TITLE_HEIGHT;h&&(y=.5*t._collapsed_width,m=-e.NODE_TITLE_HEIGHT),i.fillStyle="#686",i.beginPath(),T.type===e.EVENT||T.shape===e.BOX_SHAPE?i.rect(y-7+.5,m-4,14,8):T.shape===e.ARROW_SHAPE?(i.moveTo(y+8,m),i.lineTo(y+-4,m-4),i.lineTo(y+-4,m+4),i.closePath()):i.arc(y,m,4,0,2*Math.PI),i.fill()}if(v){y=t._collapsed_width,m=-.5*e.NODE_TITLE_HEIGHT;h&&(y=.5*t._collapsed_width,m=0),i.fillStyle="#686",i.strokeStyle="black",i.beginPath(),T.type===e.EVENT||T.shape===e.BOX_SHAPE?i.rect(y-7+.5,m-4,14,8):T.shape===e.ARROW_SHAPE?(i.moveTo(y+6,m),i.lineTo(y-6,m-4),i.lineTo(y-6,m+4),i.closePath()):i.arc(y,m,4,0,2*Math.PI),i.fill()}}}else{if(t.inputs)for(var b=0;b<t.inputs.length;b++){var T=t.inputs[b];if(i.globalAlpha=r,this.connecting_node&&!e.isValidConnection(T.type,d.type)&&(i.globalAlpha=.4*r),i.fillStyle=null!=T.link?T.color_on||this.default_connection_color.input_on:T.color_off||this.default_connection_color.input_off,(E=t.getConnectionPos(!0,b,_))[0]-=t.pos[0],E[1]-=t.pos[1],g<E[1]+.5*e.NODE_SLOT_HEIGHT&&(g=E[1]+.5*e.NODE_SLOT_HEIGHT),i.beginPath(),T.type===e.EVENT||T.shape===e.BOX_SHAPE?h?i.rect(E[0]-5+.5,E[1]-8+.5,10,14):i.rect(E[0]-6+.5,E[1]-5+.5,14,10):T.shape===e.ARROW_SHAPE?(i.moveTo(E[0]+8,E[1]+.5),i.lineTo(E[0]-4,E[1]+6+.5),i.lineTo(E[0]-4,E[1]-6+.5),i.closePath()):o?i.rect(E[0]-4,E[1]-4,8,8):i.arc(E[0],E[1],4,0,2*Math.PI),i.fill(),c)(w=null!=T.label?T.label:T.name)&&(i.fillStyle=e.NODE_TEXT_COLOR,h||T.dir==e.UP?i.fillText(w,E[0],E[1]-10):i.fillText(w,E[0]+10,E[1]+5))}if(this.connecting_node&&(i.globalAlpha=.4*r),i.textAlign=h?"center":"right",i.strokeStyle="black",t.outputs)for(var b=0;b<t.outputs.length;b++){var E,w,T=t.outputs[b];if((E=t.getConnectionPos(!1,b,_))[0]-=t.pos[0],E[1]-=t.pos[1],g<E[1]+.5*e.NODE_SLOT_HEIGHT&&(g=E[1]+.5*e.NODE_SLOT_HEIGHT),i.fillStyle=T.links&&T.links.length?T.color_on||this.default_connection_color.output_on:T.color_off||this.default_connection_color.output_off,i.beginPath(),T.type===e.EVENT||T.shape===e.BOX_SHAPE?h?i.rect(E[0]-5+.5,E[1]-8+.5,10,14):i.rect(E[0]-6+.5,E[1]-5+.5,14,10):T.shape===e.ARROW_SHAPE?(i.moveTo(E[0]+8,E[1]+.5),i.lineTo(E[0]-4,E[1]+6+.5),i.lineTo(E[0]-4,E[1]-6+.5),i.closePath()):o?i.rect(E[0]-4,E[1]-4,8,8):i.arc(E[0],E[1],4,0,2*Math.PI),i.fill(),o||i.stroke(),c)(w=null!=T.label?T.label:T.name)&&(i.fillStyle=e.NODE_TEXT_COLOR,h||T.dir==e.DOWN?i.fillText(w,E[0],E[1]-8):i.fillText(w,E[0]-10,E[1]+5))}if(i.textAlign="left",i.globalAlpha=1,t.widgets){var C=g;(h||t.widgets_up)&&(C=2),null!=t.widgets_start_y&&(C=t.widgets_start_y),this.drawNodeWidgets(t,C,i,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&i.restore(),i.globalAlpha=1}}},l.prototype.drawLinkTooltip=function(t,e){var i=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(i[0],i[1],3,0,2*Math.PI),t.fill(),null!=e.data&&(!this.onDrawLinkTooltip||1!=this.onDrawLinkTooltip(t,e,this))){var n=e.data,s=null;if(null!=(s=n.constructor===Number?n.toFixed(2):n.constructor===String?'"'+n+'"':n.constructor===Boolean?String(n):n.toToolTip?n.toToolTip():"["+n.constructor.name+"]")){s=s.substr(0,30),t.font="14px Courier New";var o=t.measureText(s).width+20;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(i[0]-.5*o,i[1]-15-24,o,24,[3]),t.moveTo(i[0]-10,i[1]-15),t.lineTo(i[0]+10,i[1]-15),t.lineTo(i[0],i[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(s,i[0],i[1]-15-24*.3)}}};var p=new Float32Array(4);l.prototype.drawNodeShape=function(t,i,n,s,o,r,a){i.strokeStyle=s,i.fillStyle=o;var h=e.NODE_TITLE_HEIGHT,u=this.ds.scale<.5,c=t._shape||t.constructor.shape||e.ROUND_SHAPE,d=t.constructor.title_mode,g=!0;d==e.TRANSPARENT_TITLE||d==e.NO_TITLE?g=!1:d==e.AUTOHIDE_TITLE&&a&&(g=!0);var _=p;_[0]=0,_[1]=g?-h:0,_[2]=n[0]+1,_[3]=g?n[1]+h:n[1];var f=i.globalAlpha;if(i.beginPath(),c==e.BOX_SHAPE||u?i.fillRect(_[0],_[1],_[2],_[3]):c==e.ROUND_SHAPE||c==e.CARD_SHAPE?i.roundRect(_[0],_[1],_[2],_[3],c==e.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):c==e.CIRCLE_SHAPE&&i.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),i.fill(),!t.flags.collapsed&&g&&(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,_[2],2)),i.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(i,this,this.canvas,this.graph_mouse),g||d==e.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(i,h,n,this.ds.scale,s);else if(d!=e.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var v=t.constructor.title_color||s;if(t.flags.collapsed&&(i.shadowColor=e.DEFAULT_SHADOW_COLOR),this.use_gradients){var y=l.gradients[v];y||((y=l.gradients[v]=i.createLinearGradient(0,0,400,0)).addColorStop(0,v),y.addColorStop(1,"#000")),i.fillStyle=y}else i.fillStyle=v;i.beginPath(),c==e.BOX_SHAPE||u?i.rect(0,-h,n[0]+1,h):c!=e.ROUND_SHAPE&&c!=e.CARD_SHAPE||i.roundRect(0,-h,n[0]+1,h,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),i.fill(),i.shadowColor="transparent"}var m=10;if(t.onDrawTitleBox?t.onDrawTitleBox(i,h,n,this.ds.scale):c==e.ROUND_SHAPE||c==e.CIRCLE_SHAPE||c==e.CARD_SHAPE?(u&&(i.fillStyle="black",i.beginPath(),i.arc(.5*h,-.5*h,6,0,2*Math.PI),i.fill()),i.fillStyle=t.boxcolor||e.NODE_DEFAULT_BOXCOLOR,u?i.fillRect(.5*h-5,-.5*h-5,m,m):(i.beginPath(),i.arc(.5*h,-.5*h,5,0,2*Math.PI),i.fill())):(u&&(i.fillStyle="black",i.fillRect(.5*(h-m)-1,-.5*(h+m)-1,12,12)),i.fillStyle=t.boxcolor||e.NODE_DEFAULT_BOXCOLOR,i.fillRect(.5*(h-m),-.5*(h+m),m,m)),i.globalAlpha=f,t.onDrawTitleText&&t.onDrawTitleText(i,h,n,this.ds.scale,this.title_text_font,r),!u){i.font=this.title_text_font;var b=String(t.getTitle());if(b)if(i.fillStyle=r?e.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed){i.textAlign="left";i.measureText(b);i.fillText(b.substr(0,20),h,e.NODE_TITLE_TEXT_Y-h),i.textAlign="left"}else i.textAlign="left",i.fillText(b,h,e.NODE_TITLE_TEXT_Y-h)}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var T=e.NODE_TITLE_HEIGHT,E=t.size[0]-T,w=e.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],E+2,2-T,T-4,T-4);i.fillStyle=w?"#888":"#555",c==e.BOX_SHAPE||u?i.fillRect(E+2,2-T,T-4,T-4):(i.beginPath(),i.roundRect(E+2,2-T,T-4,T-4,[4]),i.fill()),i.fillStyle="#333",i.beginPath(),i.moveTo(E+.2*T,.6*-T),i.lineTo(E+.8*T,.6*-T),i.lineTo(E+.5*T,.3*-T),i.fill()}t.onDrawTitle&&t.onDrawTitle(i)}r&&(t.onBounding&&t.onBounding(_),d==e.TRANSPARENT_TITLE&&(_[1]-=h,_[3]+=h),i.lineWidth=1,i.globalAlpha=.8,i.beginPath(),c==e.BOX_SHAPE?i.rect(-6+_[0],-6+_[1],12+_[2],12+_[3]):c==e.ROUND_SHAPE||c==e.CARD_SHAPE&&t.flags.collapsed?i.roundRect(-6+_[0],-6+_[1],12+_[2],12+_[3],[2*this.round_radius]):c==e.CARD_SHAPE?i.roundRect(-6+_[0],-6+_[1],12+_[2],12+_[3],[2*this.round_radius,2,2*this.round_radius,2]):c==e.CIRCLE_SHAPE&&i.arc(.5*n[0],.5*n[1],.5*n[0]+6,0,2*Math.PI),i.strokeStyle=e.NODE_BOX_OUTLINE_COLOR,i.stroke(),i.strokeStyle=s,i.globalAlpha=1)};var c=new Float32Array(4),d=new Float32Array(4),g=new Float32Array(2),_=new Float32Array(2);function f(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function v(t,e,i,n,s,o){return i<t&&i+s>t&&n<e&&n+o>e}function y(t,e){var i=t[0]+t[2],n=t[1]+t[3],s=e[0]+e[2],o=e[1]+e[3];return!(t[0]>s||t[1]>o||i<e[0]||n<e[1])}function m(t,e){e=e||{},this.options=e;var i=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var n=null;e.event&&(n=e.event.constructor.name),"MouseEvent"!==n&&"CustomEvent"!==n&&"PointerEvent"!==n&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),e.event=null);var s=document.createElement("div");function o(t){var i=parseInt(s.style.top);return s.style.top=(i+t.deltaY*e.scroll_speed).toFixed()+"px",t.preventDefault(),!0}if(s.className="litegraph litecontextmenu litemenubar-panel",e.className&&(s.className+=" "+e.className),s.style.minWidth=100,s.style.minHeight=100,s.style.pointerEvents="none",setTimeout((function(){s.style.pointerEvents="auto"}),100),s.addEventListener("mouseup",(function(t){return t.preventDefault(),!0}),!0),s.addEventListener("contextmenu",(function(t){return 2!=t.button||t.preventDefault(),!1}),!0),s.addEventListener("mousedown",(function(t){if(2==t.button)return i.close(),t.preventDefault(),!0}),!0),e.scroll_speed||(e.scroll_speed=.1),s.addEventListener("wheel",o,!0),s.addEventListener("mousewheel",o,!0),this.root=s,e.title){var r=document.createElement("div");r.className="litemenu-title",r.innerHTML=e.title,s.appendChild(r)}for(var a=0;a<t.length;a++){var l=t.constructor==Array?t[a]:a;null!=l&&l.constructor!==String&&(l=void 0===l.content?String(l):l.content);var h=t[a];this.addItem(l,h,e)}s.addEventListener("mouseleave",(function(t){i.lock||(s.closing_timer&&clearTimeout(s.closing_timer),s.closing_timer=setTimeout(i.close.bind(i,t),500))})),s.addEventListener("mouseenter",(function(t){s.closing_timer&&clearTimeout(s.closing_timer)}));var u=document;e.event&&(u=e.event.target.ownerDocument),u||(u=document),u.fullscreenElement?u.fullscreenElement.appendChild(s):u.body.appendChild(s);var p=e.left||0,c=e.top||0;if(e.event){if(p=e.event.clientX-10,c=e.event.clientY-10,e.title&&(c-=20),e.parentMenu){var d=e.parentMenu.root.getBoundingClientRect();p=d.left+d.width}var g=document.body.getBoundingClientRect(),_=s.getBoundingClientRect();0==g.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),g.width&&p>g.width-_.width-10&&(p=g.width-_.width-10),g.height&&c>g.height-_.height-10&&(c=g.height-_.height-10)}s.style.left=p+"px",s.style.top=c+"px",e.scale&&(s.style.transform="scale("+e.scale+")")}function b(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}l.prototype.drawConnections=function(t){var i=e.getTime(),n=this.visible_area;c[0]=n[0]-20,c[1]=n[1]-20,c[2]=n[2]+40,c[3]=n[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,o=0,r=s.length;o<r;++o){var a=s[o];if(a.inputs&&a.inputs.length)for(var l=0;l<a.inputs.length;++l){var h=a.inputs[l];if(h&&null!=h.link){var u=h.link,p=this.graph.links[u];if(p){var f=this.graph.getNodeById(p.origin_id);if(null!=f){var v=p.origin_slot,m=null;m=-1==v?[f.pos[0]+10,f.pos[1]+10]:f.getConnectionPos(!1,v,g);var b=a.getConnectionPos(!0,l,_);if(d[0]=m[0],d[1]=m[1],d[2]=b[0]-m[0],d[3]=b[1]-m[1],d[2]<0&&(d[0]+=d[2],d[2]=Math.abs(d[2])),d[3]<0&&(d[1]+=d[3],d[3]=Math.abs(d[3])),y(d,c)){var T=f.outputs[v],E=a.inputs[l];if(T&&E){var w=T.dir||(f.horizontal?e.DOWN:e.RIGHT),C=E.dir||(a.horizontal?e.UP:e.LEFT);if(this.renderLink(t,m,b,p,!1,0,null,w,C),p&&p._last_time&&i-p._last_time<1e3){var k=2-.002*(i-p._last_time),N=t.globalAlpha;t.globalAlpha=N*k,this.renderLink(t,m,b,p,!0,k,"white",w,C),t.globalAlpha=N}}}}}}}}t.globalAlpha=1},l.prototype.renderLink=function(t,i,n,s,o,r,a,h,u,p){s&&this.visible_links.push(s),!a&&s&&(a=s.color||l.link_type_colors[s.type]),a||(a=this.default_link_color),null!=s&&this.highlighted_links[s.id]&&(a="#FFF"),h=h||e.RIGHT,u=u||e.LEFT;var c=f(i,n);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(p=p||1)>1&&(t.lineWidth=.5),t.beginPath();for(var d=0;d<p;d+=1){var g=5*(d-.5*(p-1));if(this.links_render_mode==e.SPLINE_LINK){t.moveTo(i[0],i[1]+g);var _=0,v=0,y=0,m=0;switch(h){case e.LEFT:_=-.25*c;break;case e.RIGHT:_=.25*c;break;case e.UP:v=-.25*c;break;case e.DOWN:v=.25*c}switch(u){case e.LEFT:y=-.25*c;break;case e.RIGHT:y=.25*c;break;case e.UP:m=-.25*c;break;case e.DOWN:m=.25*c}t.bezierCurveTo(i[0]+_,i[1]+v+g,n[0]+y,n[1]+m+g,n[0],n[1]+g)}else if(this.links_render_mode==e.LINEAR_LINK){t.moveTo(i[0],i[1]+g);_=0,v=0,y=0,m=0;switch(h){case e.LEFT:_=-1;break;case e.RIGHT:_=1;break;case e.UP:v=-1;break;case e.DOWN:v=1}switch(u){case e.LEFT:y=-1;break;case e.RIGHT:y=1;break;case e.UP:m=-1;break;case e.DOWN:m=1}t.lineTo(i[0]+15*_,i[1]+15*v+g),t.lineTo(n[0]+15*y,n[1]+15*m+g),t.lineTo(n[0],n[1]+g)}else{if(this.links_render_mode!=e.STRAIGHT_LINK)return;t.moveTo(i[0],i[1]);var b=i[0],T=i[1],E=n[0],w=n[1];h==e.RIGHT?b+=10:T+=10,u==e.LEFT?E-=10:w-=10,t.lineTo(b,T),t.lineTo(.5*(b+E),T),t.lineTo(.5*(b+E),w),t.lineTo(E,w),t.lineTo(n[0],n[1])}}this.render_connections_border&&this.ds.scale>.6&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var C=this.computeConnectionPoint(i,n,.5,h,u);if(s&&s._pos&&(s._pos[0]=C[0],s._pos[1]=C[1]),this.ds.scale>=.6&&this.highquality_render&&u!=e.CENTER){if(this.render_connection_arrows){var k=this.computeConnectionPoint(i,n,.25,h,u),N=this.computeConnectionPoint(i,n,.26,h,u),O=this.computeConnectionPoint(i,n,.75,h,u),S=this.computeConnectionPoint(i,n,.76,h,u),A=0,I=0;this.render_curved_connections?(A=-Math.atan2(N[0]-k[0],N[1]-k[1]),I=-Math.atan2(S[0]-O[0],S[1]-O[1])):I=A=n[1]>i[1]?0:Math.PI,t.save(),t.translate(k[0],k[1]),t.rotate(A),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(O[0],O[1]),t.rotate(I),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}if(r){t.fillStyle=a;for(d=0;d<5;++d){var x=(.001*e.getTime()+.2*d)%1;C=this.computeConnectionPoint(i,n,x,h,u);t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}}},l.prototype.computeConnectionPoint=function(t,i,n,s,o){s=s||e.RIGHT,o=o||e.LEFT;var r=f(t,i),a=t,l=[t[0],t[1]],h=[i[0],i[1]],u=i;switch(s){case e.LEFT:l[0]+=-.25*r;break;case e.RIGHT:l[0]+=.25*r;break;case e.UP:l[1]+=-.25*r;break;case e.DOWN:l[1]+=.25*r}switch(o){case e.LEFT:h[0]+=-.25*r;break;case e.RIGHT:h[0]+=.25*r;break;case e.UP:h[1]+=-.25*r;break;case e.DOWN:h[1]+=.25*r}var p=(1-n)*(1-n)*(1-n),c=(1-n)*(1-n)*3*n,d=3*(1-n)*(n*n),g=n*n*n;return[p*a[0]+c*l[0]+d*h[0]+g*u[0],p*a[1]+c*l[1]+d*h[1]+g*u[1]]},l.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var i=this.visible_nodes,n=0;n<i.length;++n){var s=i[n];t.fillStyle="black",t.fillRect(s.pos[0]-e.NODE_TITLE_HEIGHT,s.pos[1]-e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT),0==s.order&&t.strokeRect(s.pos[0]-e.NODE_TITLE_HEIGHT+.5,s.pos[1]-e.NODE_TITLE_HEIGHT+.5,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(s.order,s.pos[0]+-.5*e.NODE_TITLE_HEIGHT,s.pos[1]-6)}t.globalAlpha=1},l.prototype.drawNodeWidgets=function(t,i,n,s){if(!t.widgets||!t.widgets.length)return 0;var o=t.size[0],r=t.widgets;i+=2;var a=e.NODE_WIDGET_HEIGHT,l=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;for(var h=e.WIDGET_OUTLINE_COLOR,u=e.WIDGET_BGCOLOR,p=e.WIDGET_TEXT_COLOR,c=e.WIDGET_SECONDARY_TEXT_COLOR,d=15,g=0;g<r.length;++g){var _=r[g],f=i;_.y&&(f=_.y),_.last_y=f,n.strokeStyle=h,n.fillStyle="#222",n.textAlign="left",_.disabled&&(n.globalAlpha*=.5);var v=_.width||o;switch(_.type){case"button":_.clicked&&(n.fillStyle="#AAA",_.clicked=!1,this.dirty_canvas=!0),n.fillRect(d,f,v-30,a),l&&!_.disabled&&n.strokeRect(d,f,v-30,a),l&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.name,.5*v,f+.7*a));break;case"toggle":n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),l?n.roundRect(d,i,v-30,a,[.5*a]):n.rect(d,i,v-30,a),n.fill(),l&&!_.disabled&&n.stroke(),n.fillStyle=_.value?"#89A":"#333",n.beginPath(),n.arc(v-30,f+.5*a,.36*a,0,2*Math.PI),n.fill(),l&&(n.fillStyle=c,null!=_.name&&n.fillText(_.name,30,f+.7*a),n.fillStyle=_.value?p:c,n.textAlign="right",n.fillText(_.value?_.options.on||"true":_.options.off||"false",v-40,f+.7*a));break;case"slider":n.fillStyle=u,n.fillRect(d,f,v-30,a);var y=_.options.max-_.options.min,m=(_.value-_.options.min)/y;if(n.fillStyle=s==_?"#89A":"#678",n.fillRect(d,f,m*(v-30),a),l&&!_.disabled&&n.strokeRect(d,f,v-30,a),_.marker){var b=(_.marker-_.options.min)/y;n.fillStyle="#AA9",n.fillRect(d+b*(v-30),f,2,a)}l&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.name+"  "+Number(_.value).toFixed(3),.5*v,f+.7*a));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),l?n.roundRect(d,i,v-30,a,[.5*a]):n.rect(d,i,v-30,a),n.fill(),l)if(_.disabled||n.stroke(),n.fillStyle=p,_.disabled||(n.beginPath(),n.moveTo(31,i+5),n.lineTo(21,i+.5*a),n.lineTo(31,i+a-5),n.fill(),n.beginPath(),n.moveTo(v-d-16,i+5),n.lineTo(v-d-6,i+.5*a),n.lineTo(v-d-16,i+a-5),n.fill()),n.fillStyle=c,n.fillText(_.name,35,f+.7*a),n.fillStyle=p,n.textAlign="right","number"==_.type)n.fillText(Number(_.value).toFixed(void 0!==_.options.precision?_.options.precision:3),v-30-20,f+.7*a);else{var T=_.value;if(_.options.values){var E=_.options.values;E.constructor===Function&&(E=E()),E&&E.constructor!==Array&&(T=E[_.value])}n.fillText(T,v-30-20,f+.7*a)}break;case"string":case"text":n.textAlign="left",n.strokeStyle=h,n.fillStyle=u,n.beginPath(),l?n.roundRect(d,i,v-30,a,[.5*a]):n.rect(d,i,v-30,a),n.fill(),l&&(_.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(d,i,v-30,a),n.clip(),n.fillStyle=c,null!=_.name&&n.fillText(_.name,30,f+.7*a),n.fillStyle=p,n.textAlign="right",n.fillText(String(_.value).substr(0,30),v-30,f+.7*a),n.restore());break;default:_.draw&&_.draw(n,t,v,f,a)}i+=(_.computeSize?_.computeSize(v)[1]:a)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"},l.prototype.processNodeWidgets=function(t,i,n,s){if(!t.widgets||!t.widgets.length)return null;for(var o=i[0]-t.pos[0],r=i[1]-t.pos[1],a=t.size[0],l=this,h=this.getCanvasWindow(),u=0;u<t.widgets.length;++u){var p=t.widgets[u];if(p&&!p.disabled){var c=p.computeSize?p.computeSize(a)[1]:e.NODE_WIDGET_HEIGHT,d=p.width||a;if(p==s||!(o<6||o>d-12||r<p.last_y||r>p.last_y+c||void 0===p.last_y)){var g=p.value;switch(p.type){case"button":"mousedown"===n.type&&(p.callback&&setTimeout((function(){p.callback(p,l,t,i,n)}),20),p.clicked=!0,this.dirty_canvas=!0);break;case"slider":p.options.max,p.options.min;var _=Math.clamp((o-15)/(d-30),0,1);p.value=p.options.min+(p.options.max-p.options.min)*_,p.callback&&setTimeout((function(){E(p,p.value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":g=p.value;if("mousemove"==n.type&&"number"==p.type)p.value+=.1*n.deltaX*(p.options.step||1),null!=p.options.min&&p.value<p.options.min&&(p.value=p.options.min),null!=p.options.max&&p.value>p.options.max&&(p.value=p.options.max);else if("mousedown"==n.type){var f=p.options.values;f&&f.constructor===Function&&(f=p.options.values(p,t));var v=null;"number"!=p.type&&(v=f.constructor===Array?f:Object.keys(f));var y=o<40?-1:o>d-40?1:0;if("number"==p.type)p.value+=.1*y*(p.options.step||1),null!=p.options.min&&p.value<p.options.min&&(p.value=p.options.min),null!=p.options.max&&p.value>p.options.max&&(p.value=p.options.max);else if(y){var m=-1;this.last_mouseclick=0,(m=f.constructor===Object?v.indexOf(String(p.value))+y:v.indexOf(p.value)+y)>=v.length&&(m=v.length-1),m<0&&(m=0),f.constructor===Array?p.value=f[m]:p.value=m}else{var b=f!=v?Object.values(f):f;new e.ContextMenu(b,{scale:Math.max(1,this.ds.scale),event:n,className:"dark",callback:T.bind(p)},h);function T(t,e,i){return f!=v&&(t=b.indexOf(t)),this.value=t,E(this,t),l.dirty_canvas=!0,!1}}}else if("mouseup"==n.type&&"number"==p.type){y=o<40?-1:o>d-40?1:0;n.click_time<200&&0==y&&this.prompt("Value",p.value,function(t){this.value=Number(t),E(this,this.value)}.bind(p),n)}g!=p.value&&setTimeout(function(){E(this,this.value)}.bind(p),20),this.dirty_canvas=!0;break;case"toggle":"mousedown"==n.type&&(p.value=!p.value,setTimeout((function(){E(p,p.value)}),20));break;case"string":case"text":"mousedown"==n.type&&this.prompt("Value",p.value,function(t){this.value=t,E(this,t)}.bind(p),n,!!p.options&&p.options.multiline);break;default:p.mouse&&(this.dirty_canvas=p.mouse(n,[o,r],t))}return g!=p.value&&(t.onWidgetChanged&&t.onWidgetChanged(p.name,p.value,g,p),t.graph._version++),p}}}function E(e,s){e.value=s,e.options&&e.options.property&&void 0!==t.properties[e.options.property]&&t.setProperty(e.options.property,s),e.callback&&e.callback(e.value,l,t,i,n)}return null},l.prototype.drawGroups=function(t,i){if(this.graph){var n=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;for(var s=0;s<n.length;++s){var o=n[s];if(y(this.visible_area,o._bounding)){i.fillStyle=o.color||"#335",i.strokeStyle=o.color||"#335";var r=o._pos,a=o._size;i.globalAlpha=.25*this.editor_alpha,i.beginPath(),i.rect(r[0]+.5,r[1]+.5,a[0],a[1]),i.fill(),i.globalAlpha=this.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(r[0]+a[0],r[1]+a[1]),i.lineTo(r[0]+a[0]-10,r[1]+a[1]),i.lineTo(r[0]+a[0],r[1]+a[1]-10),i.fill();var l=o.font_size||e.DEFAULT_GROUP_FONT_SIZE;i.font=l+"px Arial",i.textAlign="left",i.fillText(o.title,r[0]+4,r[1]+l)}}i.restore()}},l.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},l.prototype.resize=function(t,e){if(!t&&!e){var i=this.canvas.parentNode;t=i.offsetWidth,e=i.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},l.prototype.switchLiveMode=function(t){if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var e=this,i=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var n=setInterval((function(){e.editor_alpha*=i,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,i<1&&e.editor_alpha<.01&&(clearInterval(n),i<1&&(e.live_mode=!0)),i>1&&e.editor_alpha>.99&&(clearInterval(n),e.editor_alpha=1)}),1)},l.prototype.onNodeSelectionChange=function(t){},l.prototype.touchHandler=function(t){var e=t.changedTouches[0],i="";switch(t.type){case"touchstart":i="mousedown";break;case"touchmove":i="mousemove";break;case"touchend":i="mouseup";break;default:return}var n=this.getCanvasWindow(),s=n.document.createEvent("MouseEvent");s.initMouseEvent(i,!0,!0,n,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(s),t.preventDefault()},l.onGroupAdd=function(t,i,n){var s=l.active_canvas,o=(s.getCanvasWindow(),new e.LGraphGroup);o.pos=s.convertEventToCanvasOffset(n),s.graph.add(o)},l.onMenuAdd=function(t,i,n,s,o){var r=l.active_canvas,a=r.getCanvasWindow(),h=r.graph;if(h)return function t(i,s){var l=e.getNodeTypesCategories(r.filter||h.filter).filter((function(t){return t.startsWith(i)})),u=[];l.map((function(e){if(e){var n=new RegExp("^("+i+")"),s=e.replace(n,"").split("/")[0],o=""===i?s+"/":i+s+"/",r=s;-1!=r.indexOf("::")&&(r=r.split("::")[1]),-1===u.findIndex((function(t){return t.value===o}))&&u.push({value:o,content:r,has_submenu:!0,callback:function(e,i,n,s){t(e.value,s)}})}})),e.getNodeTypesInCategory(i.slice(0,-1),r.filter||h.filter).map((function(t){if(!t.skip_list){var i={value:t.type,content:t.title,has_submenu:!1,callback:function(t,i,n,s){var a=s.getFirstEvent();r.graph.beforeChange();var l=e.createNode(t.value);l&&(l.pos=r.convertEventToCanvasOffset(a),r.graph.add(l)),o&&o(l),r.graph.afterChange()}};u.push(i)}})),new e.ContextMenu(u,{event:n,parentMenu:s},a)}("",s),!1},l.onMenuCollapseAll=function(){},l.onMenuNodeEdit=function(){},l.showMenuNodeOptionalInputs=function(t,i,n,s,o){if(o){var r=this,a=l.active_canvas.getCanvasWindow();i=o.optional_inputs;o.onGetInputs&&(i=o.onGetInputs());var h=[];if(i)for(var u=0;u<i.length;u++){var p=i[u];if(p){var c=p[0];p[2]||(p[2]={}),p[2].label&&(c=p[2].label),p[2].removable=!0;var d={content:c,value:p};p[1]==e.ACTION&&(d.className="event"),h.push(d)}else h.push(null)}if(this.onMenuNodeInputs&&(h=this.onMenuNodeInputs(h)),h.length){new e.ContextMenu(h,{event:n,callback:function(t,e,i){if(!o)return;t.callback&&t.callback.call(r,o,t,e,i);t.value&&(o.graph.beforeChange(),o.addInput(t.value[0],t.value[1],t.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange())},parentMenu:s,node:o},a);return!1}console.log("no input entries")}},l.showMenuNodeOptionalOutputs=function(t,i,n,s,o){if(o){var r=this,a=l.active_canvas.getCanvasWindow();i=o.optional_outputs;o.onGetOutputs&&(i=o.onGetOutputs());var h=[];if(i)for(var u=0;u<i.length;u++){var p=i[u];if(p){if(!o.flags||!o.flags.skip_repeated_outputs||-1==o.findOutputSlot(p[0])){var c=p[0];p[2]||(p[2]={}),p[2].label&&(c=p[2].label),p[2].removable=!0;var d={content:c,value:p};p[1]==e.EVENT&&(d.className="event"),h.push(d)}}else h.push(null)}if(this.onMenuNodeOutputs&&(h=this.onMenuNodeOutputs(h)),h.length){new e.ContextMenu(h,{event:n,callback:function t(i,n,a){if(!o)return;i.callback&&i.callback.call(r,o,i,n,a);if(!i.value)return;var l=i.value[1];if(l&&(l.constructor===Object||l.constructor===Array)){var h=[];for(var u in l)h.push({content:u,value:l[u]});return new e.ContextMenu(h,{event:n,callback:t,parentMenu:s,node:o}),!1}o.graph.beforeChange(),o.addOutput(i.value[0],i.value[1],i.value[2]),o.setDirtyCanvas(!0,!0),o.graph.afterChange()},parentMenu:s,node:o},a);return!1}}},l.onShowMenuNodeProperties=function(t,i,n,s,o){if(o&&o.properties){var r=l.active_canvas,a=r.getCanvasWindow(),h=[];for(var u in o.properties){"object"==typeof(t=void 0!==o.properties[u]?o.properties[u]:" ")&&(t=JSON.stringify(t));var p=o.getPropertyInfo(u);"enum"!=p.type&&"combo"!=p.type||(t=l.getPropertyPrintableValue(t,p.values)),t=l.decodeHTML(t),h.push({content:"<span class='property_name'>"+(p.label?p.label:u)+"</span><span class='property_value'>"+t+"</span>",value:u})}if(h.length){new e.ContextMenu(h,{event:n,callback:function(t,e,i,n){if(!o)return;var s=this.getBoundingClientRect();r.showEditPropertyValue(o,t.value,{position:[s.left,s.top]})},parentMenu:s,allow_html:!0,node:o},a);return!1}}},l.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},l.onResizeNode=function(t,e,i,n,s){s&&(s.size=s.computeSize(),s.onResize&&s.onResize(s.size),s.setDirtyCanvas(!0,!0))},l.prototype.showLinkMenu=function(t,i){var n=this;console.log(t);var s=new e.ContextMenu(["Add Node",null,"Delete"],{event:i,title:null!=t.data?t.data.constructor.name:null,callback:function(e,i,o){switch(e){case"Add Node":l.onMenuAdd(null,null,o,s,(function(e){console.log("node autoconnect");var i=n.graph.getNodeById(t.origin_id),s=n.graph.getNodeById(t.target_id);e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&i.outputs[t.origin_slot].type==e.inputs[0].type&&e.outputs[0].type==s.inputs[0].type&&(i.connect(t.origin_slot,e,0),e.connect(0,s,t.target_slot),e.pos[0]-=.5*e.size[0])}));break;case"Delete":n.graph.removeLink(t.id)}}});return!1},l.onShowPropertyEditor=function(t,e,i,n,s){var o=t.property||"title",r=s[o],a=document.createElement("div");a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.querySelector(".name").innerText=o;var h=a.querySelector(".value");h&&(h.value=r,h.addEventListener("blur",(function(t){this.focus()})),h.addEventListener("keydown",(function(t){13!=t.keyCode&&"textarea"!=t.target.localName||(g(),t.preventDefault(),t.stopPropagation())})));var u=l.active_canvas.canvas,p=u.getBoundingClientRect(),c=-20,d=-20;function g(){!function(e){"Number"==t.type?e=Number(e):"Boolean"==t.type&&(e=Boolean(e));s[o]=e,a.parentNode&&a.parentNode.removeChild(a);s.setDirtyCanvas(!0,!0)}(h.value)}p&&(c-=p.left,d-=p.top),event?(a.style.left=event.clientX+c+"px",a.style.top=event.clientY+d+"px"):(a.style.left=.5*u.width+c+"px",a.style.top=.5*u.height+d+"px"),a.querySelector("button").addEventListener("click",g),u.parentNode.appendChild(a)},l.prototype.prompt=function(t,e,i,n,s){var o=this;t=t||"";var r=!1,a=document.createElement("div");a.className="graphdialog rounded",a.innerHTML=s?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",a.close=function(){o.prompt_box=null,a.parentNode&&a.parentNode.removeChild(a)},this.ds.scale>1&&(a.style.transform="scale("+this.ds.scale+")"),a.addEventListener("mouseleave",(function(t){r||a.close()})),o.prompt_box&&o.prompt_box.close(),o.prompt_box=a;a.querySelector(".name").innerText=t;var h=a.querySelector(".value");h.value=e;var u=h;u.addEventListener("keydown",(function(t){if(r=!0,27==t.keyCode)a.close();else{if(13!=t.keyCode||"textarea"==t.target.localName)return;i&&i(this.value),a.close()}t.preventDefault(),t.stopPropagation()})),a.querySelector("button").addEventListener("click",(function(t){i&&i(u.value),o.setDirty(!0),a.close()}));var p=l.active_canvas.canvas,c=p.getBoundingClientRect(),d=-20,g=-20;return c&&(d-=c.left,g-=c.top),n?(a.style.left=n.clientX+d+"px",a.style.top=n.clientY+g+"px"):(a.style.left=.5*p.width+d+"px",a.style.top=.5*p.height+g+"px"),p.parentNode.appendChild(a),setTimeout((function(){u.focus()}),10),a},l.search_limit=-1,l.prototype.showSearchBox=function(t){var i=this,n=l.active_canvas,s=n.canvas,o=s.ownerDocument||document,r=document.createElement("div");r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",r.close=function(){i.search_box=null,o.body.focus(),o.body.style.overflow="",setTimeout((function(){i.canvas.focus()}),20),r.parentNode&&r.parentNode.removeChild(r)};var a=null;this.ds.scale>1&&(r.style.transform="scale("+this.ds.scale+")"),r.addEventListener("mouseenter",(function(t){a&&(clearTimeout(a),a=null)})),r.addEventListener("mouseleave",(function(t){a=setTimeout((function(){r.close()}),500)})),i.search_box&&i.search_box.close(),i.search_box=r;var h=r.querySelector(".helper"),u=null,p=null,c=null,d=r.querySelector("input");d&&(d.addEventListener("blur",(function(t){this.focus()})),d.addEventListener("keydown",(function(t){if(38==t.keyCode)y(!1);else if(40==t.keyCode)y(!0);else if(27==t.keyCode)r.close();else{if(13!=t.keyCode)return p&&clearInterval(p),void(p=setTimeout(m,10));c?v(c.innerHTML):u?v(u):r.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0}))),o.fullscreenElement?o.fullscreenElement.appendChild(r):(o.body.appendChild(r),o.body.style.overflow="hidden");var g=s.getBoundingClientRect(),_=(t?t.clientX:g.left+.5*g.width)-80,f=(t?t.clientY:g.top+.5*g.height)-20;function v(s){if(s)if(i.onSearchBoxSelection)i.onSearchBoxSelection(s,t,n);else{var o=e.searchbox_extras[s.toLowerCase()];o&&(s=o.type),n.graph.beforeChange();var a=e.createNode(s);if(a&&(a.pos=n.convertEventToCanvasOffset(t),n.graph.add(a)),o&&o.data){if(o.data.properties)for(var l in o.data.properties)a.addProperty(l,o.data.properties[l]);if(o.data.inputs)for(var l in a.inputs=[],o.data.inputs)a.addOutput(o.data.inputs[l][0],o.data.inputs[l][1]);if(o.data.outputs)for(var l in a.outputs=[],o.data.outputs)a.addOutput(o.data.outputs[l][0],o.data.outputs[l][1]);o.data.title&&(a.title=o.data.title),o.data.json&&a.configure(o.data.json),n.graph.afterChange()}}r.close()}function y(t){var e=c;c&&c.classList.remove("selected"),c?(c=t?c.nextSibling:c.previousSibling)||(c=e):c=t?h.childNodes[0]:h.childNodes[h.childNodes.length],c&&(c.classList.add("selected"),c.scrollIntoView({block:"end",behavior:"smooth"}))}function m(){p=null;var t=d.value;if(u=null,h.innerHTML="",t)if(i.onSearchBox){var s=i.onSearchBox(h,t,n);if(s)for(var o=0;o<s.length;++o)y(s[o])}else{var r=0;t=t.toLowerCase();var a=n.filter||n.graph.filter;for(var o in e.searchbox_extras){var c=e.searchbox_extras[o];if(-1!==c.desc.toLowerCase().indexOf(t)){var g=e.registered_node_types[c.type];if((!g||g.filter==a)&&(y(c.desc,"searchbox_extra"),-1!==l.search_limit&&r++>l.search_limit))break}}var _=null;if(Array.prototype.filter)_=Object.keys(e.registered_node_types).filter(f);else for(var o in _=[],e.registered_node_types)f(o)&&_.push(o);for(o=0;o<_.length&&(y(_[o]),!(-1!==l.search_limit&&r++>l.search_limit));o++);function f(i){var n=e.registered_node_types[i];return(!a||n.filter==a)&&-1!==i.toLowerCase().indexOf(t)}}function y(t,e){var i=document.createElement("div");u||(u=t),i.innerText=t,i.dataset.type=escape(t),i.className="litegraph lite-search-item",e&&(i.className+=" "+e),i.addEventListener("click",(function(t){v(unescape(this.dataset.type))})),h.appendChild(i)}}return r.style.left=_+"px",r.style.top=f+"px",t.layerY>g.height-200&&(h.style.maxHeight=g.height-t.layerY-20+"px"),d.focus(),r},l.prototype.showEditPropertyValue=function(t,e,i){if(t&&void 0!==t.properties[e]){i=i||{};var n=t.getPropertyInfo(e),s=n.type,o="";if("string"==s||"number"==s||"array"==s||"object"==s)o="<input autofocus type='text' class='value'/>";else if("enum"!=s&&"combo"!=s||!n.values){if("boolean"!=s)return void console.warn("unknown type: "+s);o="<input autofocus type='checkbox' class='value' "+(t.properties[e]?"checked":"")+"/>"}else{for(var r in o="<select autofocus type='text' class='value'>",n.values){var a=r;n.values.constructor===Array&&(a=n.values[r]),o+="<option value='"+a+"' "+(a==t.properties[e]?"selected":"")+">"+n.values[r]+"</option>"}o+="</select>"}var l=this.createDialog("<span class='name'>"+(n.label?n.label:e)+"</span>"+o+"<button>OK</button>",i);if("enum"!=s&&"combo"!=s||!n.values)if("boolean"==s){(h=l.querySelector("input"))&&h.addEventListener("click",(function(t){p(!!h.checked)}))}else{var h;if(h=l.querySelector("input")){h.addEventListener("blur",(function(t){this.focus()}));a=void 0!==t.properties[e]?t.properties[e]:"";"string"!==s&&(a=JSON.stringify(a)),h.value=a,h.addEventListener("keydown",(function(t){13==t.keyCode&&(u(),t.preventDefault(),t.stopPropagation())}))}}else(h=l.querySelector("select")).addEventListener("change",(function(t){p(t.target.value)}));return l.querySelector("button").addEventListener("click",u),l}function u(){p(h.value)}function p(o){n&&n.values&&n.values.constructor===Object&&void 0!=n.values[o]&&(o=n.values[o]),"number"==typeof t.properties[e]&&(o=Number(o)),"array"!=s&&"object"!=s||(o=JSON.parse(o)),t.properties[e]=o,t.graph&&t.graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,o),i.onclose&&i.onclose(),l.close(),t.setDirtyCanvas(!0,!0)}},l.prototype.createDialog=function(t,e){e=e||{};var i=document.createElement("div");i.className="graphdialog",i.innerHTML=t;var n=this.canvas.getBoundingClientRect(),s=-20,o=-20;return n&&(s-=n.left,o-=n.top),e.position?(s+=e.position[0],o+=e.position[1]):e.event?(s+=e.event.clientX,o+=e.event.clientY):(s+=.5*this.canvas.width,o+=.5*this.canvas.height),i.style.left=s+"px",i.style.top=o+"px",this.canvas.parentNode.appendChild(i),i.close=function(){this.parentNode&&this.parentNode.removeChild(this)},i},l.prototype.createPanel=function(t,i){var n=(i=i||{}).window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),i.width&&(s.style.width=i.width+(i.width.constructor===Number?"px":"")),i.height&&(s.style.height=i.height+(i.height.constructor===Number?"px":"")),i.closable){var o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",(function(){s.close()})),s.header.appendChild(o)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=t,s.content=s.querySelector(".dialog-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){this.parentNode&&this.parentNode.removeChild(this)},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(t,e,i){var n=document.createElement("div");return e&&(n.className=e),n.innerHTML=t,i?s.footer.appendChild(n):s.content.appendChild(n),n},s.addButton=function(t,e,i){var n=document.createElement("button");return n.innerText=t,n.options=i,n.classList.add("btn"),n.addEventListener("click",e),s.footer.appendChild(n),n},s.addSeparator=function(){var t=document.createElement("div");t.className="separator",s.content.appendChild(t)},s.addWidget=function(t,i,o,r,a){r=r||{};var h=String(o);"number"==(t=t.toLowerCase())&&(h=o.toFixed(3));var u=document.createElement("div");u.className="property",u.innerHTML="<span class='property_name'></span><span class='property_value'></span>",u.querySelector(".property_name").innerText=r.label||i;var p=u.querySelector(".property_value");if(p.innerText=h,u.dataset.property=i,u.dataset.type=r.type||t,u.options=r,u.value=o,"boolean"==t)u.classList.add("boolean"),o&&u.classList.add("bool-on"),u.addEventListener("click",(function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",c(t,this.value)}));else if("string"==t||"number"==t)p.setAttribute("contenteditable",!0),p.addEventListener("keydown",(function(t){"Enter"==t.code&&(t.preventDefault(),this.blur())})),p.addEventListener("blur",(function(){var t=this.innerText,e=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(t=Number(t)),c(e,t)}));else if("enum"==t||"combo"==t){h=l.getPropertyPrintableValue(o,r.values);p.innerText=h,p.addEventListener("click",(function(t){var i=r.values||[],s=this.parentNode.dataset.property,o=this;new e.ContextMenu(i,{event:t,className:"dark",callback:function(t,e,i){return o.innerText=t,c(s,t),!1}},n)}))}function c(t,e){console.log("change",t,e),r.callback&&r.callback(t,e),a&&a(t,e)}return s.content.appendChild(u),u},s},l.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var i="";for(var n in e)if(e[n]==t){i=n;break}return String(t)+" ("+i+")"}},l.prototype.showShowNodePanel=function(t){window.SELECTED_NODE=t;var e=document.querySelector("#node-panel");e&&e.close();var i=this.getCanvasWindow();(e=this.createPanel(t.title||"",{closable:!0,window:i})).id="node-panel",e.node=t,e.classList.add("settings");var n=this;function s(){for(var i in e.content.innerHTML="",e.addHTML("<span class='node_type'>"+t.type+"</span><span class='node_desc'>"+(t.constructor.desc||"")+"</span><span class='separator'></span>"),e.addHTML("<h3>Properties</h3>"),t.properties){var s=t.properties[i],o=t.getPropertyInfo(i);o.type;t.onAddPropertyToPanel&&t.onAddPropertyToPanel(i,e)||e.addWidget(o.widget||o.type,i,s,o,(function(e,i){n.graph.beforeChange(t),t.setProperty(e,i),n.graph.afterChange(),n.dirty_canvas=!0}))}e.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(e),e.addButton("Delete",(function(){t.block_delete||(t.graph.remove(t),e.close())})).classList.add("delete")}s(),this.canvas.parentNode.appendChild(e)},l.prototype.showSubgraphPropertiesDialog=function(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var i=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function n(){if(i.clear(),t.inputs)for(var e=0;e<t.inputs.length;++e){var s=t.inputs[e];if(!s.not_subgraph_input){var o=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");o.dataset.name=s.name,o.dataset.slot=e,o.querySelector(".name").innerText=s.name,o.querySelector(".type").innerText=s.type,o.querySelector("button").addEventListener("click",(function(e){t.removeInput(Number(this.parentNode.dataset.slot)),n()}))}}}i.node=t,i.classList.add("subgraph_dialog");return i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(e){var i=this.parentNode,s=i.querySelector(".name").value,o=i.querySelector(".type").value;s&&-1==t.findInputSlot(s)&&(t.addInput(s,o),i.querySelector(".name").value="",i.querySelector(".type").value="",n())})),n(),this.canvas.parentNode.appendChild(i),i},l.prototype.showSubgraphPropertiesDialogRight=function(t){var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var i=this.createPanel("Subgraph Outputs",{closable:!0,width:500});function n(){if(i.clear(),t.outputs)for(var e=0;e<t.outputs.length;++e){var s=t.outputs[e];if(!s.not_subgraph_output){var o=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");o.dataset.name=s.name,o.dataset.slot=e,o.querySelector(".name").innerText=s.name,o.querySelector(".type").innerText=s.type,o.querySelector("button").addEventListener("click",(function(e){t.removeOutput(Number(this.parentNode.dataset.slot)),n()}))}}}i.node=t,i.classList.add("subgraph_dialog");var s=i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function o(){var e=this.parentNode,i=e.querySelector(".name").value,s=e.querySelector(".type").value;i&&-1==t.findOutputSlot(i)&&(t.addOutput(i,s),e.querySelector(".name").value="",e.querySelector(".type").value="",n())}return s.querySelector(".name").addEventListener("keydown",(function(t){13==t.keyCode&&o.apply(this)})),s.querySelector("button").addEventListener("click",(function(t){o.apply(this)})),n(),this.canvas.parentNode.appendChild(i),i},l.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var i=t[e];i.node&&(i.node.graph&&i.graph==this.graph||i.close())}},l.onMenuNodeCollapse=function(t,e,i,n,s){s.graph.beforeChange(s),s.collapse(),s.graph.afterChange(s)},l.onMenuNodePin=function(t,e,i,n,s){s.pin()},l.onMenuNodeMode=function(t,i,n,s,o){return new e.ContextMenu(["Always","On Event","On Trigger","Never"],{event:n,callback:function(t){if(!o)return;switch(t){case"On Event":o.mode=e.ON_EVENT;break;case"On Trigger":o.mode=e.ON_TRIGGER;break;case"Never":o.mode=e.NEVER;break;case"Always":default:o.mode=e.ALWAYS}},parentMenu:s,node:o}),!1},l.onMenuNodeColors=function(t,i,n,s,o){if(!o)throw"no node for color";var r=[];for(var a in r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),l.node_colors){var h=l.node_colors[a];t={value:a,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+h.color+"; background-color:"+h.bgcolor+"'>"+a+"</span>"};r.push(t)}return new e.ContextMenu(r,{event:n,callback:function(t){if(!o)return;var i=t.value?l.node_colors[t.value]:null;i?o.constructor===e.LGraphGroup?o.color=i.groupcolor:(o.color=i.color,o.bgcolor=i.bgcolor):(delete o.color,delete o.bgcolor);o.setDirtyCanvas(!0,!0)},parentMenu:s,node:o}),!1},l.onMenuNodeShapes=function(t,i,n,s,o){if(!o)throw"no node passed";return new e.ContextMenu(e.VALID_SHAPES,{event:n,callback:function(t){if(!o)return;o.graph.beforeChange(o),o.shape=t,o.graph.afterChange(o),o.setDirtyCanvas(!0)},parentMenu:s,node:o}),!1},l.onMenuNodeRemove=function(t,e,i,n,s){if(!s)throw"no node passed";if(!1!==s.removable){var o=s.graph;o.beforeChange(),o.remove(s),o.afterChange(),s.setDirtyCanvas(!0,!0)}},l.onMenuNodeToSubgraph=function(t,i,n,s,o){var r=o.graph,a=l.active_canvas;if(a){var h=Object.values(a.selected_nodes||{});h.length||(h=[o]);var u=e.createNode("graph/subgraph");u.pos=o.pos.concat(),r.add(u),u.buildFromNodes(h),a.deselectAllNodes(),o.setDirtyCanvas(!0,!0)}},l.onMenuNodeClone=function(t,e,i,n,s){if(0!=s.clonable){var o=s.clone();o&&(o.pos=[s.pos[0]+5,s.pos[1]+5],s.graph.beforeChange(),s.graph.add(o),s.graph.afterChange(),s.setDirtyCanvas(!0,!0))}},l.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},l.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:l.onMenuAdd},{content:"Add Group",callback:l.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t},l.prototype.getNodeMenuOptions=function(t){var e=null;if(e=t.getMenuOptions?t.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:l.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:l.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:l.onShowMenuNodeProperties},null,{content:"Title",callback:l.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:l.onMenuNodeMode},{content:"Resize",callback:function(){if(t.resizable)return l.onResizeNode}},{content:"Collapse",callback:l.onMenuNodeCollapse},{content:"Pin",callback:l.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:l.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:l.onMenuNodeShapes},null],t.onGetInputs){var i=t.onGetInputs();i&&i.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var n=t.onGetOutputs();n&&n.length&&(e[1].disabled=!1)}if(t.getExtraMenuOptions){var s=t.getExtraMenuOptions(this,e);s&&(s.push(null),e=s.concat(e))}return!1!==t.clonable&&e.push({content:"Clone",callback:l.onMenuNodeClone}),e.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:l.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(e,t),e},l.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:l.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:l.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:l.onShowPropertyEditor},null,{content:"Remove",callback:l.onMenuNodeRemove}]},l.prototype.processContextMenu=function(t,i){var n=this,s=l.active_canvas.getCanvasWindow(),o=null,r={event:i,callback:function(e,i,s){if(!e)return;if("Remove Slot"==e.content)return void((o=e.slot).input?t.removeInput(o.slot):o.output&&t.removeOutput(o.slot));if("Disconnect Links"==e.content)return void((o=e.slot).output?t.disconnectOutput(o.slot):o.input&&t.disconnectInput(o.slot));if("Rename Slot"==e.content){var o,r=(o=e.slot).input?t.getInputInfo(o.slot):t.getOutputInfo(o.slot),a=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",i),l=a.querySelector("input");l&&r&&(l.value=r.label||""),a.querySelector("button").addEventListener("click",(function(t){l.value&&(r&&(r.label=l.value),n.setDirty(!0)),a.close()}))}},extra:t};t&&(r.title=t.type);var a=null;if(t&&(a=t.getSlotInPosition(i.canvasX,i.canvasY),l.active_node=t),a){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(a);else{a&&a.output&&a.output.links&&a.output.links.length&&o.push({content:"Disconnect Links",slot:a});var h=a.input||a.output;o.push(h.locked||!h.removable?"Cannot remove":{content:"Remove Slot",slot:a}),o.push(h.nameLocked?"Cannot rename":{content:"Rename Slot",slot:a})}r.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==e.ACTION&&(r.title="Action"),a.output&&a.output.type==e.EVENT&&(r.title="Event")}else if(t)o=this.getNodeMenuOptions(t);else{o=this.getCanvasMenuOptions();var u=this.graph.getGroupOnPos(i.canvasX,i.canvasY);u&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:u,options:this.getGroupMenuOptions(u)}})}if(o)new e.ContextMenu(o,r,s)},"undefined"!=typeof window&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(t,e,i,n,s,o){var r=0,a=0,l=0,h=0;if(0!==s){if(void 0===o&&(o=s),null!=s&&s.constructor===Array)if(1==s.length)r=a=l=h=s[0];else if(2==s.length)r=h=s[0],a=l=s[1];else{if(4!=s.length)return;r=s[0],a=s[1],l=s[2],h=s[3]}else r=s||0,a=s||0,l=o||0,h=o||0;this.moveTo(t+r,e),this.lineTo(t+i-a,e),this.quadraticCurveTo(t+i,e,t+i,e+a),this.lineTo(t+i,e+n-h),this.quadraticCurveTo(t+i,e+n,t+i-h,e+n),this.lineTo(t+h,e+n),this.quadraticCurveTo(t,e+n,t,e+n-l),this.lineTo(t,e+l),this.quadraticCurveTo(t,e,t+r,e)}else this.rect(t,e,i,n)}),e.compareObjects=function(t,e){for(var i in t)if(t[i]!=e[i])return!1;return!0},e.distance=f,e.colorToString=function(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"},e.isInsideRectangle=v,e.growBounding=function(t,e,i){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),i<t[1]?t[1]=i:i>t[3]&&(t[3]=i)},e.isInsideBounding=function(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])},e.overlapBounding=y,e.hex2num=function(t){"#"==t.charAt(0)&&(t=t.slice(1)),t=t.toUpperCase();for(var e,i,n="0123456789ABCDEF",s=new Array(3),o=0,r=0;r<6;r+=2)e=n.indexOf(t.charAt(r)),i=n.indexOf(t.charAt(r+1)),s[o]=16*e+i,o++;return s},e.num2hex=function(t){for(var e,i,n="0123456789ABCDEF",s="#",o=0;o<3;o++)e=t[o]/16,i=t[o]%16,s+=n.charAt(e)+n.charAt(i);return s},m.prototype.addItem=function(t,e,i){var n=this;i=i||{};var s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;function r(t){var e=this.value,s=!0;(n.current_submenu&&n.current_submenu.close(t),i.callback)&&(!0===i.callback.call(this,e,i,t,n,i.node)&&(s=!1));if(e){if(e.callback&&!i.ignore_item_callbacks&&!0!==e.disabled)!0===e.callback.call(this,e,i,t,n,i.extra)&&(s=!1);if(e.submenu){if(!e.submenu.options)throw"ContextMenu submenu needs options";new n.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:n,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:i.autoopen});s=!1}}s&&!n.lock&&n.close()}return null===e?s.classList.add("separator"):(s.innerHTML=e&&e.title?e.title:t,s.value=e,e&&(e.disabled&&(o=!0,s.classList.add("disabled")),(e.submenu||e.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof e?(s.dataset.value=t,s.onclick_callback=e):s.dataset.value=e,e.className&&(s.className+=" "+e.className)),this.root.appendChild(s),o||s.addEventListener("click",r),i.autoopen&&s.addEventListener("mouseenter",(function(t){var e=this.value;if(!e||!e.has_submenu)return;r.call(this,t)})),s},m.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!m.isCursorOverElement(t,this.parentMenu.root)&&m.trigger(this.parentMenu.root,"mouseleave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},m.trigger=function(t,e,i,n){var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,!0,!0,i),s.srcElement=n,t.dispatchEvent?t.dispatchEvent(s):t.__events&&t.__events.dispatchEvent(s),s},m.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},m.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},m.isCursorOverElement=function(t,e){var i=t.clientX,n=t.clientY,s=e.getBoundingClientRect();return!!s&&(n>s.top&&n<s.top+s.height&&i>s.left&&i<s.left+s.width)},e.ContextMenu=m,e.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);for(n=0;n<i.length;n++)i[n].close?i[n].close():i[n].parentNode&&i[n].parentNode.removeChild(i[n])}},e.extendClass=function(t,e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i]);if(e.prototype)for(var i in e.prototype)e.prototype.hasOwnProperty(i)&&(t.prototype.hasOwnProperty(i)||(e.prototype.__lookupGetter__(i)?t.prototype.__defineGetter__(i,e.prototype.__lookupGetter__(i)):t.prototype[i]=e.prototype[i],e.prototype.__lookupSetter__(i)&&t.prototype.__defineSetter__(i,e.prototype.__lookupSetter__(i))))},b.sampleCurve=function(t,e){if(e){for(var i=0;i<e.length-1;++i){var n=e[i],s=e[i+1];if(!(s[0]<t)){var o=s[0]-n[0];if(Math.abs(o)<1e-5)return n[1];var r=(t-n[0])/o;return n[1]*(1-r)+s[1]*r}}return 0}},b.prototype.draw=function(t,e,i,n,s,o){var r=this.points;if(r){this.size=e;var a=e[0]-2*this.margin,l=e[1]-2*this.margin;s=s||"#666",t.save(),t.translate(this.margin,this.margin),n&&(t.fillStyle="#111",t.fillRect(0,0,a,l),t.fillStyle="#222",t.fillRect(.5*a,0,1,l),t.strokeStyle="#333",t.strokeRect(0,0,a,l)),t.strokeStyle=s,o&&(t.globalAlpha=.5),t.beginPath();for(var h=0;h<r.length;++h){var u=r[h];t.lineTo(u[0]*a,(1-u[1])*l)}if(t.stroke(),t.globalAlpha=1,!o)for(h=0;h<r.length;++h){u=r[h];t.fillStyle=this.selected==h?"#FFF":this.nearest==h?"#DDD":"#AAA",t.beginPath(),t.arc(u[0]*a,(1-u[1])*l,2,0,2*Math.PI),t.fill()}t.restore()}},b.prototype.onMouseDown=function(t,e){var i=this.points;if(i&&!(t[1]<0)){var n=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=t[0]-this.margin,r=t[1]-this.margin,a=[o,r],l=30/e.ds.scale;if(this.selected=this.getCloserPoint(a,l),-1==this.selected){var h=[o/n,1-r/s];i.push(h),i.sort((function(t,e){return t[0]-e[0]})),this.selected=i.indexOf(h),this.must_update=!0}return-1!=this.selected||void 0}},b.prototype.onMouseMove=function(t,e){var i=this.points;if(i){var n=this.selected;if(!(n<0)){var s=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),r=[t[0]-this.margin,t[1]-this.margin],a=30/e.ds.scale;this._nearest=this.getCloserPoint(r,a);var l=i[n];if(l){var h=0==n||n==i.length-1;if(!h&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10))return i.splice(n,1),void(this.selected=-1);l[0]=h?0==n?0:1:Math.clamp(s,0,1),l[1]=1-Math.clamp(o,0,1),i.sort((function(t,e){return t[0]-e[0]})),this.selected=i.indexOf(l),this.must_update=!0}}}},b.prototype.onMouseUp=function(t,e){return this.selected=-1,!1},b.prototype.getCloserPoint=function(t,e){var i=this.points;if(!i)return-1;e=e||30;for(var n=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=i.length,r=[0,0],a=1e6,l=-1,h=0;h<o;++h){var u=i[h];r[0]=u[0]*n,r[1]=(1-u[1])*s,r[0]<t[0]&&h;var p=vec2.distance(t,r);p>a||p>e||(l=h,a=p)}return l},e.CurveEditor=b,e.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},Math.clamp=function(t,e,i){return e>t?e:i<t?i:t},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),e.LiteGraph=this.LiteGraph}}]);